<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Multi-Level Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>body {
  margin: 0;
  padding: 0;
  display: flex;
  min-height: 100vh;
  background: #f9fafb;
}

.navbar {
  background: linear-gradient(90deg, #0d6efd, #0a58ca);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.navbar .nav-link {
  color: #fff !important;
}

/* Sidebar */
.sidebar {
  width: 260px;
  background: #f8f9fa;
  border-right: 1px solid #dee2e6;
  position: fixed;
  top: 70px;
  bottom: 0;
  left: 0;
  overflow-y: auto;
  padding: 20px;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
}

.sidebar h5 {
  font-weight: 600;
  margin-bottom: 15px;
}

.sidebar .form-select,
.sidebar input {
  border-radius: 8px;
  margin-bottom: 15px;
}

/* Summary Cards */
.sidebar .summary-card {
  padding: 8px;
  margin-bottom: 12px;
  border-radius: 12px;
  color: #fff;
  text-align: center;
}

.sidebar .summary-card i {
  font-size: 1.4rem;
  margin-bottom: 4px;
}

.sidebar .summary-card h6 {
  font-size: 0.85rem;
  margin-bottom: 2px;
}

.sidebar .summary-card p {
  font-size: 0.9rem;
  font-weight: 600;
  margin: 0;
}

/* Content area */
.content {
  margin-left: 260px;
  padding: 90px 25px 25px;
  flex: 1;
  overflow-x: hidden;
  transition: margin-left 0.3s ease;
}

/* Responsive Fix */
@media (max-width: 992px) {
  .sidebar {
    position: fixed;
    left: -260px;
    transition: left 0.3s ease;
  }

  .sidebar.active {
    left: 0;
  }

  .content {
    margin-left: 0;
    padding-top: 90px;
  }
}

#deviceTypeCards { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:50px; }
.device-type-card { flex:1 1 calc(33.33% - 10px); max-width:calc(33.33% - 10px); height:120px; background:linear-gradient(135deg,#0d6efd,#6610f2); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); cursor:pointer; transition:0.3s; }
.device-type-card:hover { transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.2); }
.device-type-card.disabled { background:#e0e0e0 !important; color:#888 !important; cursor:not-allowed; }
.device-card { padding:10px; border-radius:12px; color:white; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:10px; max-width:300px; width:100%; }
.device-card.bg-success { background:#fff; border:2px solid #28a745; color:#000; min-height:60px; max-width:400px; }
.device-card.bg-danger { background:#fff; border:2px solid #dc3545; color:#000; min-height:60px; max-width:400px; }
#deviceDetailsContainer { display:none; }
#deviceList { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; align-items: flex-start; margin-bottom: 20px; }
/* ‚≠ê jab sirf 1 device ho ‚Üí center kar do */
#deviceList:only-child,
#deviceList > .device-card:only-child{
  margin-left: auto;
  margin-right: auto;
}
#deviceList .device-card { flex: 1 1 200px; max-width: 250px; min-width: 180px; }
#alarmLog tr td { vertical-align:middle; }
/* Hover effect for device cards */
.device-card {
  position: relative;
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.device-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

/* Overlay text on hover */
.device-card::after {
  content: "View Graph";
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
  background: rgba(0, 0, 0, 0.55);
  opacity: 0;
  transition: opacity 0.3s ease;
  border-radius: 12px;
}

.device-card:hover::after {
  opacity: 1;
}

</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">IoT Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">

        <!-- User Management Dropdown -->
        <li class="nav-item dropdown"id="userManagementNav">
          <a class="nav-link dropdown-toggle" href="#" id="userManagementDropdown" role="button" data-bs-toggle="dropdown">
            User Management
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userManagementDropdown">
            <!-- <li>
              <a class="dropdown-item" href="#" onclick="showUserList()">View Users</a>
            </li> -->
            <li>
              <a class="dropdown-item" href="#" onclick="showUserForm()">Create User</a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="showUserOrgCentreLinkForm()">User-Organization-Centre Links</a>
            </li>
          </ul>
        </li>

        <!-- Logout -->
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="logout()">Logout</a>
        </li>

      </ul>
    </div>
  </div>
</nav>


<div class="sidebar">
  <div class="sidebar-content">
    
    <h5>Filters</h5>
    <label>Organization Name</label>
    <select id="organizationSelect" class="form-select mb-3"><option value="">Select Organization</option></select>
    <label>Centre Name</label>
    <select id="centreSelect" class="form-select mb-3"><option value="">Select Centre</option></select>
<!-- <hr>
<h5>User Management</h5>
<ul id="userManagementMenuItem" class="list-unstyled">
  <li><a href="#" class="btn btn-outline-primary w-100 mb-2" onclick="showUserList()">View Users</a></li>
  <li><a href="#" class="btn btn-outline-success w-100" onclick="showUserForm()">Create User</a></li>
</ul>
<li>
  <a class="dropdown-item" href="#" onclick="showUserOrgCentreLinkForm()">User-Organization-Centre Links</a>
</li>
 -->



    <label for="startDateTime">Start Date & Time</label>
    <input type="datetime-local" id="startDateTime" class="form-control mb-2">
    <label for="endDateTime">End Date & Time</label>
    <input type="datetime-local" id="endDateTime" class="form-control mb-3">
    <div class="d-flex gap-2 mt-2 mb-3">
  
  <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
    Clear
  </button>

  <button class="btn btn-sm btn-success" onclick="applyDateFilter()">
    Apply
  </button>

</div>
    <h5>Summary</h5>
    <div id="summaryCards">
      <div class="summary-card bg-primary text-center mb-3">
        <i class="bi bi-hdd-network"></i><h6>Total Devices</h6><p id="totalDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-success text-center mb-3">
        <i class="bi bi-check-circle"></i><h6>Active Devices</h6><p id="activeDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-danger text-center mb-3">
        <i class="bi bi-x-circle"></i><h6>Offline Devices</h6><p id="offlineDevices" class="fs-5 fw-bold">0</p>
      </div>
    </div>
  </div>

  
</div>

<div class="content">
  <div id="deviceTypeCards" class="d-flex flex-wrap gap-3"></div>

  <div id="deviceDetailsContainer">
    <button class="btn btn-sm btn-secondary mb-3" onclick="backToDashboard()">‚Üê Back</button>
    <h4 id="deviceTypeTitle"></h4>
   
    <!-- <button class="btn btn-primary btn-sm" onclick="manualRefresh()">
  Refresh Data
</button> -->


    <div id="deviceList" class="mb-1"></div>        
    <div style="max-width:700px;margin:auto;display:flex;gap:15px;align-items:flex-start;">
      <div style="flex:0 0 150px;display:flex;flex-direction:column;gap:10px;margin-left:-200px;">
        <div style="max-width:250px;background:#dc3545;color:#fff;border-radius:10px;padding:8px;text-align:center; margin-left:20px;" class="mb-3">
          <h6 style="font-size:0.8rem;margin-bottom:4px;">Total Alarms (24h)</h6>
          <p id="alarm24h" class="fs-6 fw-bold">0</p>
        </div>
      </div>
      <div style="flex:1;background:#fff;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);padding:15px;">
        <canvas id="deviceGraph" style="max-height:300px;"></canvas>
      </div>
    </div>
    
    <div style="display:flex;justify-content:flex-end;align-items:center;gap:10px;">
  
  <span id="lastRefreshText" style="font-size:0.8rem;color:#555;">
    Last refreshed: never
  </span>

  <button type="button" class="btn btn-sm btn-outline-primary" onclick="manualRefresh()">
    <i class="bi bi-arrow-clockwise"></i> Refresh Data
  </button>

</div>

<br>
<br>


    <h5 class="mt-4 d-flex justify-content-between align-items-center">
      Alarm Log  <span class="badge bg-danger">Active Alarms   <span class="badge bg-danger" id="activeAlarmCount">0</span></span>
    </h5>
    <table class="table table-striped">
      <thead><tr><th>Device</th><th>Alarm</th><th>Time</th><th>Status</th></tr></thead>
      <tbody id="alarmLog"></tbody>
    </table>
  </div>

  <!-- User Management Section -->


  <!-- Create User Form -->
  <!-- Create User Form -->
<div id="userFormContainer" class="card shadow-sm p-4 my-4" style="display:none; max-width: 1000px; margin:auto; border-radius:12px;">
  <h4 class="mb-4 text-primary">Create New User</h4>
  <form id="createUserForm">
    
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="newActualName" class="form-label fw-semibold">Actual Name</label>
        <input type="text" id="newActualName" class="form-control" required placeholder="Enter actual name">
      </div>
      <div class="col-md-6">
        <label for="newUsername" class="form-label fw-semibold">Username</label>
        <input type="text" id="newUsername" class="form-control" required placeholder="Enter username">
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="phone" class="form-label fw-semibold">Phone</label>
        <input type="text" class="form-control" id="phone" placeholder="Enter phone">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="sendSMS">
          <label class="form-check-label" for="sendSMS">Send SMS</label>
        </div>
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label fw-semibold">Email</label>
        <input type="email" class="form-control" id="email" placeholder="Enter email">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="sendEmail">
          <label class="form-check-label" for="sendEmail">Send Email</label>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="newPassword" class="form-label fw-semibold">Password</label>
        <input type="password" id="newPassword" class="form-control" required
               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$"
               title="Min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char"
               placeholder="Enter strong password">
      </div>

      <div class="col-md-6">
        <label for="confirmPassword" class="form-label fw-semibold">Confirm Password</label>
        <input type="password" id="confirmPassword" class="form-control" required
               placeholder="Re-enter password">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-12">
        <input type="checkbox" id="showPassword" onclick="togglePassword()"> Show Passwords
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label for="validityStart" class="form-label fw-semibold">Validity Start</label>
        <input type="date" id="validityStart" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="validityEnd" class="form-label fw-semibold">Validity End</label>
        <input type="date" id="validityEnd" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="newUserRole" class="form-label fw-semibold">Role</label>
        <select id="newUserRole" class="form-select">
          <option value="2">IoT Admin</option>
          <option value="3" selected>Normal User</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-start mt-4">
      <button type="submit" class="btn btn-primary me-3 px-4">Create</button>
      <button type="button" class="btn btn-outline-secondary px-4" onclick="document.getElementById('userFormContainer').style.display='none'">Cancel</button>
    </div>

  </form>

  <div id="userManagementSection" style="display:none; margin-top:20px;">

  <!-- User List -->
  <div id="userListContainer" style="display:none;">
    <h4>User List</h4>
    <table class="table table-bordered mt-3">
  <thead>
    <tr>
      <th>S NO.</th>
      <th>Username</th>
      <th>Actual Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Role</th>
      <th>Validity</th>
    </tr>
  </thead>
  <tbody id="userListBody"></tbody>
</table>

  </div>
</div>


</div>

<!-- Modal / Section for linking users -->
<div id="userOrgCentreLinkSection" class="card shadow-sm p-4 my-4" style="display:none; max-width: 900px; margin:auto; border-radius:12px;">
  <h4 class="mb-4 text-primary">User-Organization-Centre Linking</h4>
  <form id="userOrgCentreLinkForm">

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="linkUserSelect" class="form-label fw-semibold">User</label>
        <select id="linkUserSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label for="linkOrgSelect" class="form-label fw-semibold">Organization</label>
        <select id="linkOrgSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label for="linkCentreSelect" class="form-label fw-semibold">Centre</label>
        <select id="linkCentreSelect" class="form-select"></select>
      </div>
    </div>

    <div class="d-flex justify-content-start mt-4">
      <button type="button" class="btn btn-primary me-3 px-4" id="saveUserLinkBtn">Save Link</button>
      <button type="button" class="btn btn-outline-secondary px-4" onclick="hideUserOrgCentreLinkForm()">Cancel</button>
    </div>

  </form>
  <hr>
  <h5>Existing Links</h5>
  <table class="table table-bordered">
    <thead>
      <tr><th>S NO.</th><th>User</th><th>Organization</th><th>Centre</th></tr>
    </thead>
    <tbody id="userOrgCentreLinksBody"></tbody>
  </table>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BASE_URL = "https://fertisense-iot-production.up.railway.app";
//const BASE_URL = "http://192.168.0.155:8000"; // direct IP
const API = {
  masterorganizations: BASE_URL + "/api/masterorganization/",
  mastercentre: BASE_URL + "/api/mastercentre/",
  devicecategory: BASE_URL + "/api/devicecategory/",
  masterDevices: BASE_URL + "/api/masterdevice/",
  devicereadinglog: BASE_URL + "/api/devicereadinglog/",
  devicealarmlog: BASE_URL + "/api/devicealarmlog/",
  userorganizationcentrelinks: BASE_URL + "/api/userorganizationcentrelink/",
  userorganizationcentrelink: BASE_URL + "/api/userorgcentre/",
  masteruom: BASE_URL + "/api/masteruom/",
  createuser: BASE_URL+"/api/masteruser/",
  masterparameter: BASE_URL + "/api/masterparameter/",
};

let centreData=[], allDevices=[], allCategories=[], currentCentreId=null, currentUser=null;
let currentCategoryId=null, liveUpdateInterval=null;
window.currentDeviceGraphDeviceId = null;

// ------------- LOAD DATA -------------
async function loadOrganizations(){
  try{
    const userRes = await fetch(BASE_URL + "/api/currentuser/");
    currentUser = await userRes.json();
    const linkRes = await fetch(API.userorganizationcentrelink + `?USER_ID=${currentUser.USER_ID}`);
    const userLinks = await linkRes.json();
    const allowedOrgIds = userLinks.map(l => l.ORGANIZATION_ID);

    const res = await fetch(API.masterorganizations);
    const orgs = await res.json();
    const orgSelect = document.getElementById("organizationSelect");
    orgSelect.innerHTML = '<option value="">Select Organization</option>';
    orgs.filter(o => allowedOrgIds.includes(o.ORGANIZATION_ID))
        .forEach(o => orgSelect.innerHTML += `<option value="${o.ORGANIZATION_ID}">${o.ORGANIZATION_NAME}</option>`);
    
    if(userLinks.length>0){
      orgSelect.value = userLinks[0].ORGANIZATION_ID;
      await loadCentres(orgSelect.value, true, userLinks[0].CENTRE_ID);
    }
  }catch(err){ console.error(err);}
}

async function loadCentres(orgId, auto = false, userCentreId = null) {
  const centreSelect = document.getElementById("centreSelect");
  centreSelect.innerHTML = '<option value="">Select Centre</option>';
  if (!orgId) return;

  try {
    if (!centreData.length) {
      const res = await fetch(API.mastercentre);
      centreData = await res.json();
    }

    // ‚úÖ Only filter by organization
    let filtered = centreData.filter(c => c.ORGANIZATION_ID == orgId);

    // ‚úÖ Populate all centres under that organization
    filtered.forEach(c => {
      centreSelect.innerHTML += `<option value="${c.CENTRE_ID}">${c.CENTRE_NAME}</option>`;
    });

    // ‚úÖ If auto-select is enabled, select the user's current centre
    if (auto && userCentreId) {
      centreSelect.value = userCentreId;
      loadDevices(userCentreId);
    }

  } catch (err) {
    console.error(err);
  }
}


async function loadDevices(centreId){
  currentCentreId=centreId;
  try{
    const res = await fetch(API.masterDevices);
    allDevices = (await res.json()).filter(d=>d.CENTRE_ID==centreId);
    const catRes = await fetch(API.devicecategory);
    allCategories = await catRes.json();
    updateSummary();
    showCategoryCards();
  }catch(err){console.error(err);}
}

// ------------- DASHBOARD UI -------------
function clearFilters(){
    document.getElementById("startDateTime").value = "";
    document.getElementById("endDateTime").value = "";

    // reload current data without filters
    if(currentCategoryId){
        updateDashboardLive(currentCategoryId);
    }

    if(window.currentDeviceGraphDeviceId){
        const d = allDevices.find(x => x.DEVICE_ID === window.currentDeviceGraphDeviceId);
        if(d){
            loadDeviceReadings(d);
        }
    }
}

function updateSummary(){
    const total = allDevices.length;
    const active = allDevices.filter(d => d.status === "active").length;
    const offline = total - active;

    document.getElementById("totalDevices").textContent = total;
    document.getElementById("activeDevices").textContent = active;
    document.getElementById("offlineDevices").textContent = offline;
}


function showCategoryCards(){
  document.getElementById("deviceDetailsContainer").style.display="none";
  const container=document.getElementById("deviceTypeCards");
  container.innerHTML="";
  allCategories.forEach(cat=>{
    const devicesOfCat = allDevices.filter(d=>d.CATEGORY_ID===cat.CATEGORY_ID);
    const count = devicesOfCat.length;
    const card = document.createElement("div");
    card.className="device-type-card";
    card.innerHTML=`<h6>${cat.CATEGORY_NAME}</h6><strong>${count}</strong>`;
    if(count>0) card.onclick=()=>openDeviceDashboard(cat.CATEGORY_ID);
    else card.classList.add('disabled');
    container.appendChild(card);
  });
}

// ========== USER MANAGEMENT SECTION ==========
// function showUserList() {
//   document.getElementById("deviceDetailsContainer").style.display = "none";
//   document.getElementById("deviceTypeCards").style.display = "none";
//   document.getElementById("userFormContainer").style.display = "none";
//   document.getElementById("userManagementSection").style.display = "block";
//   document.getElementById("userListContainer").style.display = "block";
//   loadUserList();
// }

function showUserForm() {
  document.getElementById("deviceDetailsContainer").style.display = "none";
  document.getElementById("deviceTypeCards").style.display = "none";
  document.getElementById("userManagementSection").style.display = "block";
  document.getElementById("userFormContainer").style.display = "block";
  document.getElementById("userListContainer").style.display = "block";
  loadUserList(); // Form ke saath hi list bhi load kar do
}

async function loadUserList() {
  try {
    const res = await fetch(BASE_URL + "/api/masteruser/");
    let users = await res.json();

    // Filter by current user & sort descending by USER_ID (latest first)
    users = users.filter(u => u.CREATED_BY === currentUser.USER_ID)
                 .sort((a,b)=> b.USER_ID - a.USER_ID);

    const tbody = document.getElementById("userListBody");
    tbody.innerHTML = "";

    users.forEach((u, index) => {
      const serial = index + 1; // Latest = 1
      const validity = `${u.VALIDITY_START || '-'} ‚Üí ${u.VALIDITY_END || '-'}`;
      tbody.innerHTML += `
        <tr>
          <td>${serial}</td>
          <td>${u.USERNAME}</td>
          <td>${u.ACTUAL_NAME}</td>
          <td>${u.EMAIL}</td>
          <td>${u.PHONE || '-'}</td>
          <td>${u.ROLE_ID == 2 ? "IoT Admin" : "User"}</td>
          <td>${validity}</td>
        </tr>
      `;
    });
  } catch (err) {
    console.error("Failed to load users:", err);
  }
}

// Form submission ke baad list reload
document.getElementById("createUserForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const now = new Date();
  const username = document.getElementById("newUsername").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const actualName = document.getElementById("newActualName").value.trim();

  // üîπ Required fields check
  if (!username || !password || !confirmPassword || !actualName || !email) {
    alert("‚ùå Please fill all required fields!");
    return;
  }

  // üîπ Password match check
  if (password !== confirmPassword) {
    alert("‚ùå Passwords do not match!");
    return;
  }

  try {
    // üîπ Fetch existing users created by current admin
    const resUsers = await fetch(BASE_URL + "/api/masteruser/");
    const users = await resUsers.json();
    const filteredUsers = users.filter(u => u.CREATED_BY === currentUser.USER_ID);

    // üîπ Frontend duplicate check
    if (filteredUsers.some(u => u.USERNAME.toLowerCase() === username.toLowerCase())) {
      alert("‚ùå Username already exists!");
      return;
    }
    if (filteredUsers.some(u => u.EMAIL.toLowerCase() === email.toLowerCase())) {
      alert("‚ùå Email already exists!");
      return;
    }

    // üîπ Prepare payload
    const payload = {
      USERNAME: username,
      PASSWORD: password,
      ACTUAL_NAME: actualName,
      EMAIL: email,
      PHONE: document.getElementById("phone").value.trim() || null,
      CREATED_BY: currentUser.USER_ID,
      CREATED_ON: now.toISOString().split("T")[0],
      VALIDITY_START: document.getElementById("validityStart").value || now.toISOString().split("T")[0],
      VALIDITY_END: document.getElementById("validityEnd").value || null,
      SEND_EMAIL: document.getElementById("sendEmail").checked,
      SEND_SMS: document.getElementById("sendSMS").checked,
      ROLE_ID: parseInt(document.getElementById("newUserRole").value),
      PASSWORD_RESET: false
    };

    // üîπ Submit to backend
    const res = await fetch(BASE_URL + "/api/masteruser/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

if (res.ok) {
    alert("‚úÖ User created successfully!");
    document.getElementById("createUserForm").reset();
    loadUserList();
} else {
    const data = await res.json();
    // üîπ Friendly error message
    let messages = [];
    if (data.USERNAME) messages.push("Username already exists!");
    if (data.EMAIL) messages.push("Email already exists!");
    const msg = messages.length ? `‚ùå ${messages.join("\n")}` : "‚ùå Failed to create user!";
    alert(msg);
}


  } catch (err) {
    alert("‚ùå Error creating user! Please try again.");
  }
});

function handleRoleDisable() {
  if (currentUser.ROLE_ID !== 2) {

    const navItem = document.getElementById("userManagementNav");
    if (navItem) {
      navItem.style.display = "none";  // navbar dropdown hide
    }
  }
}



// üîπ Show/hide section
function showUserOrgCentreLinkForm(){
  document.getElementById("deviceTypeCards").style.display="none";
  document.getElementById("deviceDetailsContainer").style.display="none";
  document.getElementById("userManagementSection").style.display="none";
  document.getElementById("userOrgCentreLinkSection").style.display="block";

  loadUsersForLink();
  loadOrganizationsForLink();
  loadUserOrgCentreLinks();
}

function togglePassword() {
  const passwordField = document.getElementById("newPassword");
  const confirmField = document.getElementById("confirmPassword");
  const checkbox = document.getElementById("showPassword");

  if (checkbox.checked) {
    passwordField.type = "text";
    confirmField.type = "text";
  } else {
    passwordField.type = "password";
    confirmField.type = "password";
  }
}



function hideUserOrgCentreLinkForm(){
  document.getElementById("userOrgCentreLinkSection").style.display="none";
  document.getElementById("deviceTypeCards").style.display="flex";
}

// üîπ Load users (only created by current user)
async function loadUsersForLink() {
  try {
    const res = await fetch(BASE_URL + "/api/masteruser/");
    const users = await res.json();
    const filteredUsers = users.filter(u => u.CREATED_BY === currentUser.USER_ID);
    const select = document.getElementById("linkUserSelect");
    select.innerHTML = '<option value="">Select User</option>';
    filteredUsers.forEach(u => {
      select.innerHTML += `<option value="${u.USER_ID}">${u.ACTUAL_NAME} (${u.USERNAME})</option>`;
    });
  } catch(err){ console.error(err); }
}

// üîπ Load organizations (current user allowed only)
async function loadOrganizationsForLink() {
  try{
    const resLinks = await fetch(API.userorganizationcentrelink + `?USER_ID=${currentUser.USER_ID}`);
    const links = await resLinks.json();
    const allowedOrgIds = [...new Set(links.map(l=>l.ORGANIZATION_ID))];

    const resOrgs = await fetch(API.masterorganizations);
    const orgs = await resOrgs.json();
    const select = document.getElementById("linkOrgSelect");
    select.innerHTML = '<option value="">Select Organization</option>';
    orgs.filter(o=>allowedOrgIds.includes(o.ORGANIZATION_ID))
        .forEach(o => select.innerHTML += `<option value="${o.ORGANIZATION_ID}">${o.ORGANIZATION_NAME}</option>`);
    
    select.addEventListener("change", e=>loadCentresForLink(e.target.value));
  }catch(err){ console.error(err); }
}

// üîπ Load centres based on selected org
async function loadCentresForLink(orgId){
  const select = document.getElementById("linkCentreSelect");
  select.innerHTML = '<option value="">Select Centre</option>';
  if(!orgId) return;
  try{
    const resCentres = await fetch(API.mastercentre);
    const centres = await resCentres.json();
    centres.filter(c => c.ORGANIZATION_ID == orgId)
           .forEach(c=> select.innerHTML += `<option value="${c.CENTRE_ID}">${c.CENTRE_NAME}</option>`);
  }catch(err){ console.error(err); }
}

document.getElementById("saveUserLinkBtn").addEventListener("click", async () => {
    const userId = document.getElementById("linkUserSelect").value;
    const orgId = document.getElementById("linkOrgSelect").value;
    const centreId = document.getElementById("linkCentreSelect").value;

    if (!userId || !orgId || !centreId) { 
        alert("Select all fields!"); 
        return; 
    }

    try {
        // ‚úÖ Get user and check CREATED_BY
        const resUsers = await fetch(BASE_URL + "/api/masteruser/");
        const users = await resUsers.json();
        const user = users.find(u => u.USER_ID == userId);
        if (!user || user.CREATED_BY != currentUser.USER_ID) {
            alert("‚ùå You can only link users you have created!");
            return;
        }

        // ‚úÖ Payload with correct created_by
        const payload = {
            USER_ID: parseInt(userId),
            ORGANIZATION_ID: parseInt(orgId),
            CENTRE_ID: parseInt(centreId),
            created_by: parseInt(currentUser.USER_ID)
        };

        const res = await fetch(API.userorganizationcentrelinks, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (res.ok) { 
            alert("‚úÖ Link saved!");
            // üîπ Reload table after save
            await loadUserOrgCentreLinks(); 
        } else {
            const data = await res.json();
            console.error("Failed to save link:", data);
            alert("‚ùå Failed to save link! Check console for details.");
        }

    } catch (err) {
        console.error("Error saving user link:", err);
        alert("‚ùå Error saving link!");
    }
});

async function loadUserOrgCentreLinks() {
  try {
    const res = await fetch(API.userorganizationcentrelinks);
    let links = await res.json();

    // üîπ Get all users, orgs, centres to map names
    const [usersRes, orgsRes, centresRes] = await Promise.all([
      fetch(API.createuser),        // masteruser
      fetch(API.masterorganizations),
      fetch(API.mastercentre)
    ]);

    const users = await usersRes.json();
    const orgs = await orgsRes.json();
    const centres = await centresRes.json();

    // üîπ Filter links created by current user & sort descending by LINK_ID (latest top)
    links = links.filter(l => l.created_by === currentUser.USER_ID)
                 .sort((a,b)=> (b.LINK_ID || 0) - (a.LINK_ID || 0));

    const tbody = document.getElementById("userOrgCentreLinksBody");
    tbody.innerHTML = "";

    links.forEach((l, index) => {
      const serial = index + 1; // Latest = 1
      const userName = users.find(u => u.USER_ID === l.USER_ID)?.ACTUAL_NAME || '-';
      const orgName = orgs.find(o => o.ORGANIZATION_ID === l.ORGANIZATION_ID)?.ORGANIZATION_NAME || '-';
      const centreName = centres.find(c => c.CENTRE_ID === l.CENTRE_ID)?.CENTRE_NAME || '-';

      tbody.innerHTML += `<tr>
          <td>${serial}</td>
          <td>${userName}</td>
          <td>${orgName}</td>
          <td>${centreName}</td>
        </tr>`;
    });

  } catch (err) {
    console.error("Failed to load user-org-centre links:", err);
  }
}

window.addEventListener('DOMContentLoaded', () => {
    const startInput = document.getElementById('validityStart');
    const endInput = document.getElementById('validityEnd');
    
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-based
    const yyyy = today.getFullYear();

    const startDate = `${yyyy}-${mm}-${dd}`;
    startInput.value = startDate;

    const endDateObj = new Date(today);
    endDateObj.setFullYear(endDateObj.getFullYear() + 1); // Add 1 year
    const endYYYY = endDateObj.getFullYear();
    const endMM = String(endDateObj.getMonth() + 1).padStart(2, '0');
    const endDD = String(endDateObj.getDate()).padStart(2, '0');
    const endDate = `${endYYYY}-${endMM}-${endDD}`;
    endInput.value = endDate;
  });


function backToDashboard(){ 
  showCategoryCards(); 
  if(liveUpdateInterval) clearInterval(liveUpdateInterval);
  window.currentDeviceGraphDeviceId = null;
}

function logout(){ fetch('/logout/').then(()=>window.location='/login/'); }

// ------------- LIVE UPDATES -------------
// ------------- LIVE UPDATES -------------
function startLiveUpdates(categoryId){
    if(liveUpdateInterval) clearInterval(liveUpdateInterval);

    // üîπ sirf ek baar update
    updateDashboardLive(categoryId);

    // ‚ùå auto refresh hata diya
    // liveUpdateInterval = setInterval(()=>updateDashboardLive(categoryId),10000);
}

function manualRefresh(){
    if(currentCategoryId){
        updateDashboardLive(currentCategoryId);
    }

    if(window.currentDeviceGraphDeviceId){
        const currentDevice = allDevices.find(
            d => d.DEVICE_ID === window.currentDeviceGraphDeviceId
        );
        if(currentDevice){
            loadDeviceReadings(currentDevice);
        }
    }
      updateLastRefreshTime();
}


function applyDateFilter(){

    if(!currentCategoryId){
        alert("Please select any device category first.");
        return;
    }

    // Dashboard update
    updateDashboardLive(currentCategoryId);

    // Graph update if device open
    if(window.currentDeviceGraphDeviceId){
        const d = allDevices.find(x => x.DEVICE_ID === window.currentDeviceGraphDeviceId);
        if(d){
            loadDeviceReadings(d);
        }
    }
}


// ----------- DEVICE STATUS FIX (VOC FRIENDLY) -----------
// ------------------- DEVICE LIVE STATUS FIX -------------------
async function updateDashboardLive(categoryId){
    if(!currentCentreId) return;

    const devices = allDevices.filter(d => d.CATEGORY_ID === categoryId);
    const [masterparameter, masteruom] = await Promise.all([
        fetch(API.masterparameter).then(r=>r.json()),
        fetch(API.masteruom).then(r=>r.json())
    ]);

    const readingsDataRaw = await (await fetch(API.devicereadinglog + `?centre=${currentCentreId}&category=${categoryId}`)).json();
    const now = new Date();

    devices.forEach(device=>{
        // 1Ô∏è‚É£ Filter readings for this device only
        const deviceReadings = readingsDataRaw
            .filter(r => r.DEVICE_ID === device.DEVICE_ID)
            .sort((a,b)=>new Date(a.READING_DATE+'T'+a.READING_TIME) - new Date(b.READING_DATE+'T'+b.READING_TIME));
        const latestReading = deviceReadings[deviceReadings.length-1];

        // 2Ô∏è‚É£ Determine online/offline
// 2Ô∏è‚É£ Determine online/offline
let status = "offline", displayVal = "Offline";

if (deviceReadings.length > 0) {
    // Filter only VOC readings for VOC devices
    const vocOnly = deviceReadings.filter(r => {
        const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(r.PARAMETER_ID));
        return param && param.PARAMETER_NAME.toLowerCase().includes("voc");
    });

    // Use latest VOC reading (if exists)
    const latestVoc = vocOnly[vocOnly.length - 1];
    const latestReading = latestVoc || deviceReadings[deviceReadings.length - 1]; // fallback

    const readingTime = new Date(latestReading.READING_DATE + 'T' + latestReading.READING_TIME);
    if (now - readingTime <= 15 * 60 * 1000) {
        status = "active";

        const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(latestReading.PARAMETER_ID));
        const uomObj = param ? masteruom.find(u => String(u.UOM_ID) === String(param.UOM_ID)) : null;
        const uom = uomObj?.UOM_NAME || '';

        displayVal = Math.round(parseFloat(latestReading.READING)) + ' ' + uom;

    }
}

device.status = status;


        // 3Ô∏è‚É£ Update device card
        const el = document.getElementById(`currentTemp_${device.DEVICE_ID}`);
        if(!el) return;
        el.textContent = displayVal;
        el.parentElement.className = status==="active" ? "device-card bg-success" : "device-card bg-secondary";
    });

    // 4Ô∏è‚É£ Update summary
    const total = devices.length;
    const active = devices.filter(d=>d.status==="active").length;
    document.getElementById("totalDevices").textContent = total;
    document.getElementById("activeDevices").textContent = active;
    document.getElementById("offlineDevices").textContent = total - active;

    // // 5Ô∏è‚É£ Refresh graph & alarms if a device is open
    // if(window.currentDeviceGraphDeviceId){
    //     const currentDevice = allDevices.find(d=>d.DEVICE_ID===window.currentDeviceGraphDeviceId);
    //     if(currentDevice) loadDeviceReadings(currentDevice);
    // }


    // Refresh chart & alarms for current device
    // if(window.currentDeviceGraphDeviceId){
    //     loadDeviceReadings(allDevices.find(d=>d.DEVICE_ID===window.currentDeviceGraphDeviceId));
    // }

    function manualRefresh(){

    if(currentCategoryId){
        updateDashboardLive(currentCategoryId);
    }
}


    // üîÅ Auto-refresh graph every 30 minutes (1800000 ms)
if (window.deviceGraphRefreshInterval) clearInterval(window.deviceGraphRefreshInterval);

// window.deviceGraphRefreshInterval = setInterval(() => {
//     if (window.currentDeviceGraphDeviceId) {
//         const currentDevice = allDevices.find(d => d.DEVICE_ID === window.currentDeviceGraphDeviceId);
//         if (currentDevice) {
//             console.log("‚è≥ Auto-refreshing graph for:", currentDevice.DEVICE_NAME);
//             loadDeviceReadings(currentDevice);
//         }
//     }
// }, 30 * 60 * 1000); // 30 minutes


    // Update summary accurately device-wise
    updateSummary();
}


// ------------- DEVICE DASHBOARD -------------
async function openDeviceDashboard(categoryId){
    currentCategoryId = categoryId;
    document.getElementById("deviceTypeCards").innerHTML="";
    document.getElementById("deviceDetailsContainer").style.display="block";
    const category = allCategories.find(c=>c.CATEGORY_ID===categoryId);
    document.getElementById("deviceTypeTitle").textContent = category?.CATEGORY_NAME || categoryId;

    const devices = allDevices.filter(d=>d.CATEGORY_ID===categoryId);
    const deviceList = document.getElementById("deviceList");
    deviceList.innerHTML = "";

    devices.forEach(device=>{
        const div = document.createElement("div");
        div.className="device-card bg-secondary";
        div.style.cursor="pointer";
        div.id = `card_${device.DEVICE_ID}`;
        div.innerHTML = `<h6>${device.DEVICE_NAME}</h6><p id="currentTemp_${device.DEVICE_ID}" style="font-weight:600;">Loading...</p>`
        ;
        div.addEventListener("click",()=>loadDeviceReadings(device));
        deviceList.appendChild(div);
    });

   // startLiveUpdates(categoryId);
}

//graph align
// üëâ ADD THIS HERE

function groupByMinute(points, mode="average") {

    const map = new Map();

    points.forEach(p => {

        const key =
            p.x.getFullYear()+"-"+
            (p.x.getMonth()+1)+"-"+
            p.x.getDate()+" "+
            p.x.getHours()+":"+
            p.x.getMinutes();

        if(!map.has(key)) map.set(key, []);
        map.get(key).push(p.y);
    });

    const result = [];

    map.forEach((values, key) => {

        let value;

        if(mode === "average") {
            value = values.reduce((a,b)=>a+b,0) / values.length;
        } else {
            value = values[values.length-1];
        }

        result.push({
            x: new Date(key),
            y: value
        });

    });

    result.sort((a,b)=>a.x - b.x);

    return result;
}

async function loadDeviceReadings(device){
    window.currentDeviceGraphDeviceId = device.DEVICE_ID;
    const masterparameter = await fetch(API.masterparameter).then(r=>r.json());
    const masteruom = await fetch(API.masteruom).then(r=>r.json());
    const startInput = document.getElementById("startDateTime").value;
    const endInput = document.getElementById("endDateTime").value;

    // üîπ Default to last 24 hours
    let start = startInput ? new Date(startInput) : new Date(Date.now() - 24 * 60 * 60 * 1000);
    let end = endInput ? new Date(endInput) : new Date();
    const now = new Date();

    const readingsDataRaw = await (await fetch(API.devicereadinglog + `?centre=${currentCentreId}&category=${currentCategoryId}`)).json();

    // üîπ Filter readings only for this device and within last 24 hours
// üîπ Filter readings only for this device and within last 24 hours
// üîπ Filter readings for this device (within selected time range)
let dataPoints = readingsDataRaw
    .filter(r => r.DEVICE_ID === device.DEVICE_ID)
    .map(r => ({
        x: new Date(r.READING_DATE + 'T' + r.READING_TIME),
        y: parseFloat(r.READING),
        paramId: r.PARAMETER_ID
    }))
    .filter(p => p.x >= start && p.x <= end);

    // üëâ convert raw readings to 1-minute points
const dataToPlot = groupByMinute(
    dataPoints.map(p => ({ x: p.x, y: p.y })), 
    "average"       // "last" bhi use kar sakte ho
);


// üîπ Detect if this category/device is VOC type
const category = allCategories.find(c => c.CATEGORY_ID === currentCategoryId);
const isVOC = category?.CATEGORY_NAME?.toLowerCase().includes("voc");

// üîπ If VOC category ‚Üí keep only VOC readings
if (isVOC) {
    const vocParam = masterparameter.find(p => p.PARAMETER_NAME.toLowerCase().includes("voc"));
    if (vocParam) {
        dataPoints = dataPoints.filter(dp => String(dp.paramId) === String(vocParam.PARAMETER_ID));
    }
}
   // üîπ Identify parameter name (VOC / Refricheck)
    const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(dataPoints[0]?.paramId));
    const paramName = param?.PARAMETER_NAME?.toLowerCase() || "";

    // üîπ Cap readings (limit Y values)
    dataPoints.forEach(p => {
        if (paramName.includes("voc") && p.y > 2000) p.y = 2000;
        if (paramName.includes("refricheck") && p.y > 15) p.y = 15;
    });

    // üîπ Update current value
    const latest = dataPoints[dataPoints.length - 1];
    const el = document.getElementById(`currentTemp_${device.DEVICE_ID}`);
if (latest) {
    const uomObj = param ? masteruom.find(u => String(u.UOM_ID) === String(param.UOM_ID)) : null;
    const uom = uomObj?.UOM_NAME || '';
    const readingVal = parseFloat(latest.y);

    // üîπ Fetch thresholds from masterparameter
    const lower = parseFloat(param?.LOWER_THRESHOLD ?? 0);
    const mid = parseFloat(param?.THRESHOLD ?? 0);
    const upper = parseFloat(param?.UPPER_THRESHOLD ?? 0);

    // üîπ Decide color
    let colorClass = "bg-success"; // default green
    if (!isNaN(readingVal)) {
        if (upper && readingVal > upper) colorClass = "bg-danger"; // High
        else if (lower && readingVal < lower) colorClass = "bg-warning"; // Low
        else colorClass = "bg-success"; // Normal
    }

    // üîπ Update UI
    el.textContent = Math.round(readingVal) + ' ' + uom;
    el.parentElement.className = `device-card ${colorClass}`;
    device.status = "active";
} else {
    el.textContent = "Offline";
    el.parentElement.className = "device-card bg-secondary";
    device.status = "offline";
}


    // üîπ Draw line chart
  const ctx = document.getElementById("deviceGraph").getContext('2d');

if (window.deviceChart) window.deviceChart.destroy();

// gradient background
const gradient = ctx.createLinearGradient(0, 0, 0, 300);
gradient.addColorStop(0, "rgba(13,110,253,.35)");
gradient.addColorStop(1, "rgba(13,110,253,0)");

window.deviceChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: dataPoints.map(p => p.x),
    datasets: [
      {
        label: device.DEVICE_NAME,
        data: dataToPlot.map(p => p.y),

        borderColor: "#0d6efd",
        backgroundColor: gradient,

        fill: true,
        tension: 0.45,

        borderWidth: 2.5,
        pointRadius: 0,
        pointHoverRadius: 2,
      },
    ],
  },

  options: {
    responsive: true,
    maintainAspectRatio: false,

    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        backgroundColor: "#111",
        titleColor: "#fff",
        bodyColor: "#fff",
        displayColors: false,
      },
    },

    scales: {
      x: {
        type: "time",
        time: { tooltipFormat: "dd-MM-yyyy HH:mm" },
        grid: { display: false },
      },
      y: {
        beginAtZero: true,
        grid: { color: "rgba(0,0,0,0.05)" },
      },
    },
  },
});


    // üîπ Update alarms
    const alarmsRaw = await (await fetch(API.devicealarmlog + `?centre=${currentCentreId}&category=${currentCategoryId}`)).json();
   // üîπ Detect VOC category
const isVOCDevice = allCategories.find(c => c.CATEGORY_ID === currentCategoryId)?.CATEGORY_NAME?.toLowerCase().includes("voc");

// üîπ Filter alarms
let alarms = alarmsRaw.filter(a => a.DEVICE_ID === device.DEVICE_ID);

if (isVOCDevice) {
    alarms = alarms.filter(a => {
        const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(a.PARAMETER_ID));
        return param && param.PARAMETER_NAME.toLowerCase().includes("voc");
    });
}

// Use robust sorting like devicealarmlog
alarms = alarms.sort((a, b) => {
    const aDateTime = new Date(
        (a.ALARM_DATE || a.CREATED_DATE || a.DATE || '') + " " + (a.ALARM_TIME || a.CREATED_TIME || '')
    );
    const bDateTime = new Date(
        (b.ALARM_DATE || b.CREATED_DATE || b.DATE || '') + " " + (b.ALARM_TIME || b.CREATED_TIME || '')
    );

    if (!isNaN(aDateTime) && !isNaN(bDateTime)) {
        return bDateTime - aDateTime; // latest first
    }

    if (a.S_NO && b.S_NO) return b.S_NO - a.S_NO;
    if (a.READING && b.READING) return b.READING - a.READING;

    return 0;
});

const alarmBody = document.getElementById("alarmLog");
alarmBody.innerHTML = "";
let activeCount = 0;

alarms.forEach(a => {
    const isActive = a.IS_ACTIVE === 1;
    if (isActive) activeCount++;
    alarmBody.innerHTML += `
        <tr>
            <td>${device.DEVICE_NAME}</td>
            <td>${a.READING ?? '-'}</td>
            <td>${a.ALARM_DATE} ${a.ALARM_TIME}</td>
            <td><span class="badge ${isActive ? 'bg-danger' : 'bg-success'}">
                ${isActive ? 'Active' : 'Resolved'}
            </span></td>
        </tr>`;
});
filterAlarmTableLast24h();

document.getElementById("alarm24h").textContent =
    alarms.filter(a => {
        const dt = new Date((a.ALARM_DATE || a.CREATED_DATE || a.DATE || '') + " " + (a.ALARM_TIME || a.CREATED_TIME || ''));
        return !isNaN(dt) && (now - dt <= 24 * 60 * 60 * 1000);
    }).length;

document.getElementById("activeAlarmCount").textContent = activeCount;

    // üîÅ Auto-refresh graph every 30 minutes (1800000 ms)
if (window.deviceGraphRefreshInterval) clearInterval(window.deviceGraphRefreshInterval);

// window.deviceGraphRefreshInterval = setInterval(() => {
//     if (window.currentDeviceGraphDeviceId) {
//         const currentDevice = allDevices.find(d => d.DEVICE_ID === window.currentDeviceGraphDeviceId);
//         if (currentDevice) {
//             console.log("‚è≥ Auto-refreshing graph for:", currentDevice.DEVICE_NAME);
//             loadDeviceReadings(currentDevice);
//         }
//     }
// }, 30 * 60 * 1000); // 30 minutes

    
    updateSummary();

}

document.querySelector('.navbar-toggler').addEventListener('click', () => {
  document.querySelector('.sidebar').classList.toggle('active');
});


// Event listeners
//document.getElementById("startDateTime").addEventListener("change",()=>{ if(currentCategoryId) updateDashboardLive(currentCategoryId); });
//document.getElementById("endDateTime").addEventListener("change",()=>{ if(currentCategoryId) updateDashboardLive(currentCategoryId); });
document.getElementById("organizationSelect").addEventListener("change",e=>loadCentres(e.target.value));
document.getElementById("centreSelect").addEventListener("change",e=>loadDevices(e.target.value));

function filterAlarmTableLast24h() {

    const now = new Date();
    const cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000); // last 24 hours

    const rows = document.querySelectorAll("#alarmLog tr");

    rows.forEach(row => {

        // üëâ Time + Date 3rd column me hai (index 2)
        const dateTimeText = row.cells[2].innerText.trim();  

        // "YYYY-MM-DD HH:mm:ss" ko JS Date me convert
        const dt = new Date(dateTimeText.replace(" ", "T"));

        // console.log(dt);  // debug chahiye to

        if (dt < cutoff) {
            row.style.display = "none";   // purane chhupa do
        } else {
            row.style.display = "";       // recent dikhao
        }
    });
}


function updateLastRefreshTime() {
    const now = new Date();

    // save in localStorage
    localStorage.setItem("lastRefreshTime", now.toString());

    // show nicely formatted
    const options = {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    };

    document.getElementById("lastRefreshText").innerText =
        "Last refreshed: " + now.toLocaleString("en-GB", options);
}

// when page loads, read last saved time
window.addEventListener("load", function () {

    const saved = localStorage.getItem("lastRefreshTime");

    if (saved) {

        const dt = new Date(saved);

        const options = {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        };

        document.getElementById("lastRefreshText").innerText =
            "Last refreshed: " + dt.toLocaleString("en-GB", options);

    } else {

        document.getElementById("lastRefreshText").innerText =
            "Last refreshed: never";
    }
});




// Initialize
(async function(){ 
    await loadOrganizations();

    // üîπ Add role-based access control
    handleRoleDisable();
})();

</script>
</body>
</html>
