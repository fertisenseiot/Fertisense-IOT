<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>

<!-- ============================================================
     üîπ META + TITLE
     ============================================================ -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Multi-Level Dashboard</title>


<!-- ============================================================
     üîπ EXTERNAL LIBRARIES
     - Bootstrap CSS
     - Bootstrap Icons
     - Chart.js + Date Adapter
     ============================================================ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- ============================================================
     üîπ CUSTOM USER DASHBOARD CSS
     ============================================================ -->
<link rel="stylesheet" href="{% static 'css/user_dashboard.css' %}">

</head>
<body>


<!-- ============================================================
     üî∑ TOP NAVBAR (DESKTOP + MOBILE COLLAPSE)
     - Shows Org & Centre
     - Logout button
     - User Management (role based)
     ============================================================ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">IoT Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

<div class="collapse navbar-collapse justify-content-end desktop-navbar" id="navbarNav">
  <ul class="navbar-nav align-items-center gap-3">

    <!-- ORG -->
<li class="nav-item text-white small d-flex flex-column me-2">
  <span style="font-weight:600;">
    Org: <span id="navbarOrgName"></span>
  </span>

    <!-- CENTRE -->
<span style="font-size:12px; opacity:.9;">
    Centre: <span id="navbarCentreName"></span>
  </span>
    </li>

    <!-- LOGOUT -->
    <li class="nav-item">
      <button class="btn btn-sm btn-outline-light"
              style="font-size:12px;"
              onclick="logout()">
        Logout
      </button>
    </li>

  </ul>
</div>



        <!-- User Management Dropdown -->
        <li class="nav-item dropdown d-none"id="userManagementNav">
          <a class="nav-link dropdown-toggle" href="#" id="userManagementDropdown" role="button" data-bs-toggle="dropdown">
            User Management
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userManagementDropdown">
            <!-- <li>
              <a class="dropdown-item" href="#" onclick="showUserList()">View Users</a>
            </li> -->
            <li>
              <a class="dropdown-item" href="#" onclick="showUserForm()">Create User</a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="showUserOrgCentreLinkForm()">User-Organization-Centre Links</a>
            </li>
          </ul>
        </li>

        <!-- Logout -->
        <!-- <li class="nav-item">
          <a class="nav-link" href="#" onclick="logout()">Logout</a>
        </li> -->

      </ul>
    </div>
  </div>
</nav>

<!-- ============================================================
     üìå SIDEBAR SECTION
     - Mobile user info
     - Org / Centre filter
     - Date filter
     - Summary cards
     ============================================================ -->
<div class="sidebar">
  <div class="sidebar-content">

    <!-- ‚≠ê Mobile User Info -->
<div class="mobile-user-info d-lg-none mb-3">

  <div class="fw-bold text-primary">
     Org: <span id="mobileOrgName">-</span>
  </div>

  <div class="fw-semibold">
     Centre: <span id="mobileCentreName">-</span>
  </div>

  <button class="btn btn-sm btn-outline-danger mt-2 w-100"
          onclick="logout()">
     Logout
  </button>

  <hr>
</div>

    
    <div id="orgFilter">
  <label>Organization Name</label>
  <select id="organizationSelect" class="form-select mb-3">
    <option value="">Select Organization</option>
  </select>
</div>

<div id="centreFilter">
  <label>Centre Name</label>
  <select id="centreSelect" class="form-select mb-3">
    <option value="">Select Centre</option>
  </select>
</div>

<!-- <hr>
<h5>User Management</h5>
<ul id="userManagementMenuItem" class="list-unstyled">
  <li><a href="#" class="btn btn-outline-primary w-100 mb-2" onclick="showUserList()">View Users</a></li>
  <li><a href="#" class="btn btn-outline-success w-100" onclick="showUserForm()">Create User</a></li>
</ul>
<li>
  <a class="dropdown-item" href="#" onclick="showUserOrgCentreLinkForm()">User-Organization-Centre Links</a>
</li>
 -->



    <label for="startDateTime">Start Date & Time</label>
    <input type="datetime-local" id="startDateTime" class="form-control mb-2">
    <label for="endDateTime">End Date & Time</label>
    <input type="datetime-local" id="endDateTime" class="form-control mb-3">
    <div class="d-flex gap-2 mt-2 mb-3">
  
  <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
    Clear
  </button>

  <button class="btn btn-sm btn-success" onclick="applyDateFilter()">
    Apply
  </button>

</div>
    <h5>Summary</h5>
    <div id="summaryCards">
      <div class="summary-card bg-primary text-center mb-3">
        <i class="bi bi-hdd-network"></i><h6>Total Devices</h6><p id="totalDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div id="activeSummaryCard" class="summary-card text-center mb-3">
        <i class="bi bi-check-circle"></i><h6>Active Devices</h6><p id="activeDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div id="offlineSummaryCard" class="summary-card text-center mb-3">
        <i class="bi bi-x-circle"></i><h6>Offline Devices</h6><p id="offlineDevices" class="fs-5 fw-bold">0</p>
      </div>
    </div>
  </div>

  
</div>

<!-- ============================================================
     üñ•Ô∏è MAIN CONTENT AREA
     - Device Category Cards
     - Device Details View
     - Graph Section
     - Alarm Table
     ============================================================ -->
<div class="content">

  <!-- ================= DEVICE CATEGORY CARDS ================= -->
  <div id="deviceTypeCards" class="d-flex flex-wrap gap-3"></div>

  <!-- ================= DEVICE DETAILS CONTAINER ================= -->
  <div id="deviceDetailsContainer">

     <!-- Back button -->
    <button class="btn btn-sm btn-secondary mb-3" onclick="backToDashboard()">‚Üê Back</button>

    <!-- Selected Category Title -->
    <h4 id="deviceTypeTitle"></h4>

     <!-- Instruction Hint -->
    <p id="deviceHintText"
   style="text-align:center;
          font-size:13px;
          color:#030405;
          margin-bottom:10px;">
     Click On Device Card To See The Details
</p>

   
    <!-- <button class="btn btn-primary btn-sm" onclick="manualRefresh()">
  Refresh Data
</button> -->

 <!-- ================= DEVICE LIST (CARDS) ================= -->
    <div id="deviceList" class="mb-1"></div>  
    
    <!-- ============================================================
         üìä GRAPH + ALARM SUMMARY WRAPPER
         ============================================================ -->
    <div class="graph-section-wrapper" 
         style="max-width:700px;margin:auto;display:flex;gap:15px;align-items:flex-start;">
    
        <div class="alarm-24h-wrapper"
            style="flex:0 0 150px;
            display:flex;
            flex-direction:column;
            gap:10px;">

        <div class="mb-3"
         style="max-width:250px;background:#dc3545;color:#fff;border-radius:10px;padding:8px;text-align:center; margin-left:20px;" class="mb-3">
         
         <h6 style="font-size:0.8rem;margin-bottom:4px;">Total Alarms (24h)</h6>
          <p id="alarm24h" class="fs-6 fw-bold">0</p>
        </div>
      </div>
      <!-- ================= GRAPH PANEL ================= -->
    <div style="flex:1;
            background:#fff;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08);
            padding:12px;">

     <!-- üîπ Graph Toolbar (Range Buttons + Avg + Offline Badge) -->
 <div class="graph-toolbar">

   <!-- Time Range Buttons -->
  <div class="range-btns">
<button class="btn btn-sm btn-outline-primary range-btn" data-min="10" onclick="setGraphRange(10)">Last 10 Min</button>
<button class="btn btn-sm btn-outline-primary range-btn" data-min="60" onclick="setGraphRange(60)">Last 1 Hour</button>
<button class="btn btn-sm btn-outline-primary range-btn" data-min="1440" onclick="setGraphRange(1440)">Last 1 Day</button>

  </div>

   <!-- Average Display -->
  <div id="avgBox">
    Avg: --
  </div>

  <!-- Offline Duration Badge -->
  <div id="offlineBadge"
     style="display:none;
            background:#dc3545;
            color:#fff;
            padding:4px 10px;
            border-radius:6px;
            font-size:12px;
            font-weight:600;">
</div>


</div>

<!-- Graph Parameter Label -->
<div id="graphParamLabel"
     style="font-weight:700;font-size:14px;color:#0d6efd;">
</div>

<!-- Chart Canvas -->
<div id="graphWrapper" style="height:160px; width:100%; position:relative;">
    <canvas id="deviceGraph"></canvas>
</div>

<div style="display:flex;justify-content:flex-end;align-items:center;gap:10px;">

   <!-- Refresh Section -->
 <span id="lastRefreshText"
      style="display:none; font-size:0.8rem; color:#555;">
</span>


  <button type="button" class="btn btn-sm btn-outline-primary" onclick="manualRefresh()">
    <i class="bi bi-arrow-clockwise"></i> Refresh Data
  </button>

</div>

<br>
<br>
<hr>
  
  
        <!-- ============================================================
             üö® ALARM LOG TABLE
             ============================================================ -->
    <h5 class="mt-4 d-flex justify-content-between align-items-center">
      Alarm Log  <span class="badge bg-danger">Active Alarms   <span class="badge bg-danger" id="activeAlarmCount">0</span></span>
    </h5>
    <table class="table table-striped alarm-table">
     <thead>
  <tr>
    <th>Device</th>
    <th>Alarm</th>
    <th>Raised Time</th>
    <th>Alarm Resolution Time</th>
    <th>Status</th>
  </tr>
</thead>

      <tbody id="alarmLog"></tbody>
    </table>
  </div>

 <!-- ============================================================
       üë§ USER MANAGEMENT SECTION
       - Create User Form
       - User List
       ============================================================ -->
<div id="userFormContainer" class="card shadow-sm p-4 my-4" style="display:none; max-width: 1000px; margin:auto; border-radius:12px;">
  <h4 class="mb-4 text-primary">Create New User</h4>
  <form id="createUserForm">
    
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="newActualName" class="form-label fw-semibold">Actual Name</label>
        <input type="text" id="newActualName" class="form-control" required placeholder="Enter actual name">
      </div>
      <div class="col-md-6">
        <label for="newUsername" class="form-label fw-semibold">Username</label>
        <input type="text" id="newUsername" class="form-control" required placeholder="Enter username">
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="phone" class="form-label fw-semibold">Phone</label>
        <input type="text" class="form-control" id="phone" placeholder="Enter phone">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="sendSMS">
          <label class="form-check-label" for="sendSMS">Send SMS</label>
        </div>
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label fw-semibold">Email</label>
        <input type="email" class="form-control" id="email" placeholder="Enter email">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="sendEmail">
          <label class="form-check-label" for="sendEmail">Send Email</label>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="newPassword" class="form-label fw-semibold">Password</label>
        <input type="password" id="newPassword" class="form-control" required
               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$"
               title="Min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char"
               placeholder="Enter strong password">
      </div>

      <div class="col-md-6">
        <label for="confirmPassword" class="form-label fw-semibold">Confirm Password</label>
        <input type="password" id="confirmPassword" class="form-control" required
               placeholder="Re-enter password">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-12">
        <input type="checkbox" id="showPassword" onclick="togglePassword()"> Show Passwords
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label for="validityStart" class="form-label fw-semibold">Validity Start</label>
        <input type="date" id="validityStart" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="validityEnd" class="form-label fw-semibold">Validity End</label>
        <input type="date" id="validityEnd" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="newUserRole" class="form-label fw-semibold">Role</label>
        <select id="newUserRole" class="form-select">
          <option value="2">IoT Admin</option>
          <option value="3" selected>Normal User</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-start mt-4">
      <button type="submit" class="btn btn-primary me-3 px-4">Create</button>
      <button type="button" class="btn btn-outline-secondary px-4" onclick="document.getElementById('userFormContainer').style.display='none'">Cancel</button>
    </div>

  </form>
  
    <!-- User List -->
  <div id="userManagementSection" style="display:none; margin-top:20px;">
  <div id="userListContainer" style="display:none;">
    <h4>User List</h4>
    <table class="table table-bordered mt-3">
  <thead>
    <tr>
      <th>S NO.</th>
      <th>Username</th>
      <th>Actual Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Role</th>
      <th>Validity</th>
    </tr>
  </thead>
  <tbody id="userListBody"></tbody>
</table>

  </div>
</div>
</div>

 <!-- ============================================================
       üîó USER-ORG-CENTRE LINK SECTION
       ============================================================ -->
<div id="userOrgCentreLinkSection" class="card shadow-sm p-4 my-4" style="display:none; max-width: 900px; margin:auto; border-radius:12px;">
  <h4 class="mb-4 text-primary">User-Organization-Centre Linking</h4>
  <form id="userOrgCentreLinkForm">

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="linkUserSelect" class="form-label fw-semibold">User</label>
        <select id="linkUserSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label for="linkOrgSelect" class="form-label fw-semibold">Organization</label>
        <select id="linkOrgSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label for="linkCentreSelect" class="form-label fw-semibold">Centre</label>
        <select id="linkCentreSelect" class="form-select"></select>
      </div>
    </div>

    <div class="d-flex justify-content-start mt-4">
      <button type="button" class="btn btn-primary me-3 px-4" id="saveUserLinkBtn">Save Link</button>
      <button type="button" class="btn btn-outline-secondary px-4" onclick="hideUserOrgCentreLinkForm()">Cancel</button>
    </div>

  </form>
  <hr>
  <h5>Existing Links</h5>
  <table class="table table-bordered">
    <thead>
      <tr><th>S NO.</th><th>User</th><th>Organization</th><th>Centre</th></tr>
    </thead>
    <tbody id="userOrgCentreLinksBody"></tbody>
  </table>
</div>

</div>

<!-- ============================================================
     üîª JS FILES
     - Bootstrap Bundle
     - Custom User Dashboard JS
     ============================================================ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/user_dashboard.js' %}"></script>
</body>
</html>
