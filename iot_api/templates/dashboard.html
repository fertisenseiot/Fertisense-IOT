<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0/dist/chartjs-adapter-luxon.min.js"></script>

<style>
body { background: #f1f3f8; font-family: 'Segoe UI', sans-serif; padding-top: 70px; }

/* Navbar */
.navbar { background: linear-gradient(90deg, #007bff, #0056b3); }
.navbar-brand { font-weight: bold; font-size: 1.3rem; }

/* Cards */
.summary-card { 
  border-radius: 16px; 
  padding: 20px; 
  color: #fff; 
  box-shadow: 0 6px 18px rgba(0,0,0,0.1); 
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.summary-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.2); }
.summary-card h5 { margin-bottom: 10px; font-weight: 600; }
.summary-card i { font-size: 2.5rem; opacity: 0.8; }

/* Table */
.table-container { 
  margin-top: 18px; 
  background: #fff; 
  padding: 20px; 
  border-radius: 16px; 
  box-shadow: 0 6px 18px rgba(0,0,0,0.08); 
  overflow-x:auto; 
}
.table thead { position: sticky; top: 0; background: #007bff; color: white; }
.table th, .table td { vertical-align: middle; white-space: nowrap; }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.05); }

/* Buttons */
.btn { border-radius: 8px; transition: all 0.2s ease; }
.btn:hover { transform: scale(1.05); }

/* Modal */
.modal-content { 
  border-radius: 16px; 
  backdrop-filter: blur(10px); 
  background: rgba(255,255,255,0.9); 
  box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
}
#modalTitle { font-weight: 600; margin-bottom: 15px; }

/* Animations */
.fade-in { animation: fadeIn 0.6s ease-in-out; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Sliding toggle style */
.switch { position: relative; display: inline-block; width: 120px; height: 34px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; background-color: #ccc; transition: 0.4s; border-radius: 34px; top: 0; left: 0; right: 0; bottom: 0; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; }
input:checked + .slider { background-color: #28a745; }
input:checked + .slider:before { transform: translateX(85px); }
.status-text { position: absolute; width: 100%; text-align: center; font-weight: bold; color: white; top: 6px; font-size: 12px; }
.inactive-row { opacity: 0.5; }

/* Add this in your CSS file or <style> tag */
.expired-row {
  background-color: #f2f2f2; /* light grey */
  color: #999; /* dim text */
}
.expired-row td {
  color: #999;
}

/* Override Bootstrap background colors with your custom HEX values */
.bg-primary {
    background-color: #4A90E2 !important;   /* Devices */
}

.bg-success {
    background-color: #2ECC71 !important;   /* Parameters */
}

.bg-warning {
    background-color: #F5A623 !important;   /* Sensors */
}

.bg-danger {
    background-color: #FF5E62 !important;   /* Organizations */
}

#tableSection {
    display: none;
}
#tableSection {
  display: none;
}
/* Popup List Styling */
.popup-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    font-size: 1rem;
}

.popup-item:last-child {
    border-bottom: none;
}

.popup-icon {
    font-size: 1.3rem;
    margin-right: 10px;
    color: #4A90E2; /* blue icon color */
}

.popup-text {
    font-weight: 500;
    color: #333;
}

/* Make popup scrollable if content large */
.modal-body {
    max-height: 420px;
    overflow-y: auto;
    padding: 20px !important;
}

/* Bigger, cleaner popup size */
#summaryPopup .modal-dialog {
    max-width: 700px !important;   /* Adjust width here */
}

#summaryPopup .modal-content {
    border-radius: 16px;
    padding: 0;
}

/* Heading style */
.popup-heading {
    font-size: 22px;
    font-weight: 700;
    padding: 20px 25px 10px;
}

/* Divider line */
.popup-divider {
    height: 1px;
    background: #e5e5e5;
    margin: 0 25px 10px;
}

/* Item list styling */
.popup-item {
    display: flex;
    align-items: center;
    padding: 14px 25px;
    font-size: 16px;
    border-bottom: 1px solid #f1f1f1;
}

.popup-icon {
    font-size: 22px;
    color: #4a90e2;
    margin-right: 12px;
}

.popup-text {
    font-weight: 500;
}



</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow">
<div class="container-fluid">
<a class="navbar-brand" href="#"><i class="bi bi-cpu"></i> IoT Dashboard</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-database"></i> Masters</a>
<ul class="dropdown-menu">
<li><a class="dropdown-item" href="#" onclick="loadTable('master organizations')">Organizations</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master centre')">Centre</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('devices category')">Devices Category</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master devices')">Devices</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master subscriptioninfo')">Master Subscription Info</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master plan type')">Master Plan Type</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master subscription history')"> Subscription History / <br> Renew Subscription</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master sensor')">Sensors</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master parameter')">Parameter</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master uom')">Uom</a></li>
<!-- <li><a class="dropdown-item" href="#" onclick="loadTable('se user')">Users</a></li> -->
<li><a class="dropdown-item" href="#" onclick="loadTable('master role')">Roles</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('sensor parameter link')">Sensor-Parameter Links</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('device sensor link')">Device-Sensor Links</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('master notification time')">Master Notification Time</a></li>

<!-- <li><a class="dropdown-item" href="#" onclick="loadTable('centre organization link')">Centre-Organization Links</a></li> -->
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-journal-text"></i> Logs & Links</a>
<ul class="dropdown-menu">
<li><a class="dropdown-item" href="#" onclick="loadTable('device reading log')">Device Readings</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('device alarm log')">Device Alarms</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('device alarm call log')">Alarm Calls</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('compass dates')">Compass Dates</a></li>
</ul>
</li>

<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-journal-text"></i>User-Management</a>
<ul class="dropdown-menu">
<li><a class="dropdown-item" href="#" onclick="loadTable('create user')">Create-User</a></li>
<li><a class="dropdown-item" href="#" onclick="loadTable('user organization centre link')">User-Organization-Centre-Links</a></li>
</ul>
</li>
</ul>
<ul class="navbar-nav ms-auto">
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-person-circle"></i> Admin</a>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" href="#">Profile</a></li>
<li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
</ul>
</li>
</ul>
</div>
</div>
</nav>

<!-- Summary Cards -->
<div class="container fade-in">
  <div class="row text-white g-4">

    <div class="col-md-3">
      <div onclick="openSummaryPopup('organizations')" 
           class="summary-card bg-danger d-flex justify-content-between align-items-center">
        <div>
          <h5>Total Organizations</h5>
          <h3 id="totalOrganizations">0</h3>
        </div>
        <i class="bi bi-building"></i>
      </div>
    </div>

    <div class="col-md-3">
      <div onclick="openSummaryPopup('devices')" 
           class="summary-card bg-primary d-flex justify-content-between align-items-center">
        <div>
          <h5>Total Devices</h5>
          <h3 id="totalDevices">0</h3>
        </div>
        <i class="bi bi-hdd-network"></i>
      </div>
    </div>

    <div class="col-md-3">
      <div onclick="openSummaryPopup('online')" 
           class="summary-card bg-success d-flex justify-content-between align-items-center">
        <div>
          <h5>Total Online Devices</h5>
          <h3 id="totalOnlineDevices">0</h3>
        </div>
        <i class="bi bi-sliders"></i>
      </div>
    </div>

    <div class="col-md-3">
      <div onclick="openSummaryPopup('offline')" 
           class="summary-card bg-warning d-flex justify-content-between align-items-center">
        <div>
          <h5>Total Offline Devices</h5>
          <h3 id="totalOfflineDevices">0</h3>
        </div>
        <i class="bi bi-thermometer-half"></i>
      </div>
    </div>

  </div>
</div>





<!-- Table -->
 <div class="container fade-in mb-4">
<div id="tableSection" class="table-container fade-in">
<h3 id="tableTitle">Select a master/log from the navbar</h3>
<button id="addBtn" class="btn btn-sm btn-primary mb-2" onclick="addRow()"><i class="bi bi-plus"></i> Add</button>
<div class="table-responsive">
<table class="table table-striped table-hover" id="mainTable"><thead></thead><tbody></tbody></table>
</div>
</div>
</div>

<!-- Modal -->
<div class="modal" id="crudModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content p-4">
<h5 id="modalTitle"></h5>
<form id="crudForm"><div id="modalFields"></div>
    <div id="crudMessage" class="alert alert-success d-none"></div> <!-- message div -->
<div class="mt-3 d-flex justify-content-end">
<button type="submit" class="btn btn-success me-2"><i class="bi bi-check2"></i> Save</button>
<button type="button" class="btn btn-secondary" onclick="closeModal()"><i class="bi bi-x"></i> Cancel</button>
</div>
</form>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// const BASE_URL = `${window.location.protocol}//${window.location.hostname}:8080/api/`; // ‚úÖ Dynamic Base URL
// const BASE_URL = "http://192.168.1.6:8000/api/"; // direct IP
// const BASE_URL = "http://192.168.0.100:8000"; // direct IP
 const BASE_URL = "https://fertisense-iot-production.up.railway.app"; // direct IP
//const BASE_URL = "http://192.168.0.155:8000"; // direct IP
// const BASE_URL = "   https://16de7fd271a3.ngrok-free.app"; // direct IP
// const BASE_URL = "https://1vs2c96b-8000.inc1.devtunnels.ms"; // direct IP

const API = {
  masterorganizations: BASE_URL + "/api/masterorganization/",
  mastercentre:        BASE_URL + "/api/mastercentre/",
  devicescategory:     BASE_URL + "/api/devicecategory/",
  masterdevices:       BASE_URL + "/api/masterdevice/",
  mastersensor:        BASE_URL + "/api/mastersensor/",
  masterparameter:     BASE_URL + "/api/masterparameter/",
  masteruom:           BASE_URL + "/api/masteruom/",
  createuser:          BASE_URL + "/api/masteruser/",
  masterrole:          BASE_URL + "/api/masterrole/",  
  // seuser:              BASE_URL + "/api/seuser/",
  devicereadinglog:    BASE_URL + "/api/devicereadinglog/",
  devicealarmlog:      BASE_URL + "/api/devicealarmlog/",
  devicealarmcalllog:  BASE_URL + "/api/devicealarmcalllog/",
  sensorparameterlink: BASE_URL + "/api/sensorparameterlink/",
  devicesensorlink:    BASE_URL + "/api/devicesensorlink/",
  compassdates:        BASE_URL + "/api/compassdates/",
  // centreorganizationlink: BASE_URL + "centreorganizationlink/",
  userorganizationcentrelink: BASE_URL + "/api/userorganizationcentrelink/",
  masternotificationtime: BASE_URL + "/api/masternotificationtime/",
  mastersubscriptioninfo: BASE_URL +"/api/mastersubscriptioninfo/",
  masterplantype: BASE_URL +"/api/masterplantype/",
  mastersubscriptionhistory: BASE_URL +"/api/subscriptionhistory/",
  devicestatusalarmlog: "/api/devicestatusalarmlog/"

  //   masterorganizations: "http://127.0.0.1:8000/api/masterorganization/",
  // mastercentre:        "http://127.0.0.1:8000/api/mastercentre/",
  // masterdevices:       "http://127.0.0.1:8000/api/masterdevice/",
  // mastersensor:        "http://127.0.0.1:8000/api/mastersensor/",
  // masterparameter:     "http://127.0.0.1:8000/api/masterparameter/",
  // masteruom:           "http://127.0.0.1:8000/api/masteruom/",
  // createuser:          "http://127.0.0.1:8000/api/masteruser/",
  // masterrole:          "http://127.0.0.1:8000/api/masterrole/",  
  // // seuser:              "http://127.0.0.1:8000/api/seuser/",
  // devicereadinglog:    "http://127.0.0.1:8000/api/devicereadinglog/",
  // devicealarmlog:      "http://127.0.0.1:8000/api/devicealarmlog/",
  // devicealarmcalllog:  "http://127.0.0.1:8000/api/devicealarmcalllog/",
  // sensorparameterlink: "http://127.0.0.1:8000/api/sensorparameterlink/",
  // devicesensorlink:    "http://127.0.0.1:8000/api/devicesensorlink/",
  // compassdates:        "http://127.0.0.1:8000/api/compassdates/",
  // // centreorganizationlink: "http://127.0.0.1:8000/api/centreorganizationlink/",
  // userorganizationcentrelink: "http://127.0.0.1:8000/api/userorganizationcentrelink/",
  // masternotificationtime: "http://127.0.0.1:8000/api/masternotificationtime/",
  // devicecategory: "http://127.0.0.1:8000/api/devicecategory/"

};

// ===== Custom header labels =====
const HEADER_LABELS = {
  ORGANIZATION_ID: "ORGANIZATION NAME",
  DEVICE_ID: "DEVICE NAME",
  Device_ID: "DEVICE NAME",
  CENTRE_ID: "CENTRE NAME",
  SENSOR_ID: "SENSOR NAME",
  PARAMETER_ID: "PARAMETER NAME",
  ROLE_ID: "ROLE NAME",
  UOM_ID: "UNIT",
  USER_ID: "USER NAME",
  CATEGORY_ID: "CATEGORY NAME",
  Subscription_ID:"Subscription_Name",
  Plan_ID:"Plan_Name",
};




// ===== Primary keys per table =====
const PRIMARY_KEYS = {
  masterorganizations: "ORGANIZATION_ID",
  mastercentre: "CENTRE_ID",
  masterdevices: "DEVICE_ID",
  mastersensor: "SENSOR_ID",
  masterparameter: "PARAMETER_ID",
  masteruom: "UOM_ID",
  createuser: "USER_ID",
  masterrole: "ROLE_ID",
  seuser: "USER_ID",
  devicereadinglog: "ID",
  devicealarmlog: "id",
  devicealarmcalllog: "ID",
  sensorparameterlink: "id",
  devicesensorlink: "id",
  compassdates: "ID",
  centreorganizationlink: "id",
  userorganizationcentrelink: "id",
  masternotificationtime: "id",
  devicescategory: "CATEGORY_ID",
  mastersubscriptioninfo: "Subscription_ID",
  masterplantype: "Plan_ID",
  mastersubscriptionhistory: "id"
};


// ===== Field schema for empty tables =====
const FIELD_SCHEMAS = {
  masterorganizations: ["ORGANIZATION_ID","ORGANIZATION_NAME",],
  mastercentre: ["CENTRE_ID","ORGANIZATION_ID","CENTRE_NAME"],
  masterdevices: ["DEVICE_ID","DEVICE_NAME","DEVICE_IP","ORGANIZATION_ID","CENTRE_ID","DEVICE_STATUS"],
  mastersensor: ["SENSOR_ID","SENSOR_NAME","SENSOR_TYPE","UOM_ID"],
  masterparameter: ["PARAMETER_ID","PARAMETER_NAME","UOM_ID","LOWER_THRESHOLD","UPPER_THRESHOLD","THRESHOLD"],
  masteruom: ["UOM_ID","UOM_NAME","SYMBOL"],
  createuser: ["USER_ID","ACTUAL_NAME","USERNAME","ROLE_ID","PHONE","SEND_SMS","EMAIL","SEND_EMAIL","PASSWORD","confirm_password","VALIDITY_START","VALIDITY_END"],
  masterrole: ["ROLE_ID","ROLE_NAME"],
  seuser: ["USER_ID","USERNAME","EMAIL","PASSWORD","ROLE","ORGANIZATION_ID"],
  devicereadinglog: ["ID","DEVICE_ID","SENSOR_ID","PARAMETER_ID","READING","RAISED_TIME"],
  devicealarmlog: ["ID","DEVICE_ID","SENSOR_ID","PARAMETER_ID","MESSAGE","RAISED_TIME"],
  devicealarmcalllog: ["ID","ALARM_ID","CALLED_AT","STATUS"],
  sensorparameterlink: ["ID","SENSOR_ID","PARAMETER_ID"],
  devicesensorlink: ["ID","DEVICE_ID","SENSOR_ID"],
  compassdates: ["ID","ORGANIZATION_ID","BRANCH_ID","CMPS_DT"],
  // centreorganizationlink: ["ID", "ORGANIZATION_ID","CENTRE_ID"],
  userorganizationcentrelink: ["USER_ID","ORGANIZATION_ID","CENTRE_ID"],
  masternotificationtime: ["NOTIFICATION_TIME","ORGANIZATION_ID"],
  devicescategory:["CATEGORY_ID","CATEGORY_NAME"],
  mastersubscriptioninfo:["Subscription_ID","Package_Name",],
  masterplantype:["Plan_ID","Plan_Name"],
  mastersubscriptionhistory:["id","Device_ID","Subscription_Start_date"	,"Subcription_End_date"	,"Subscription_ID","Plan_ID","Payment_Date","Status"]
};

// helpers
function normalizeKey(name){ return name.replace(/\s+/g,"").toLowerCase(); }
async function fetchJSON(url){
  const res = await fetch(url);
  if(!res.ok){ throw new Error(`${res.status} ${res.statusText} -> ${url}`); }
  return res.json();
}
function logout(){ fetch('/logout/').then(()=>window.location='/login/'); }
function formatTitle(table) {
  if (!table) return "";

  let t = table;

  // 1Ô∏è‚É£ Check if starts with 'master'
  if (/^master/i.test(t)) {
    t = t.replace(/^master/i, "Master ");
  }

    if (/^devicescategory/i.test(t)) {
    t = t.replace(/^devicescategory/i, "Device Category ");
  }

  if (/^devicesensorlink/i.test(t)) {
    t = t.replace(/^devicesensorlink/i, "Device Senor Link");
  }
  
  if (/^sensorparameterlink/i.test(t)) {
    t = t.replace(/^sensorparameterlink/i, "Sensor Parameter Link");
  }

  if (/^userorganizationcentrelink/i.test(t)) {
    t = t.replace(/^userorganizationcentrelink/i, "User Organization Centre Link");
  }

  // 2Ô∏è‚É£ Replace underscores or hyphens with spaces
  t = t.replace(/[_-]+/g, " ");

  // 3Ô∏è‚É£ Add space before uppercase letters (camelCase split)
  t = t.replace(/([a-z])([A-Z])/g, "$1 $2");

  // 4Ô∏è‚É£ Handle long mixed words like ‚ÄúUserorganizationcentrelink‚Äù
  t = t.replace(/([A-Z]+)([A-Z][a-z])/g, "$1 $2");

  // 5Ô∏è‚É£ Capitalize every word nicely
  t = t.replace(/\b\w+/g, word => {
    // If full word is uppercase (like API, ID), leave it
    return word.toUpperCase() === word
      ? word
      : word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });

  // 6Ô∏è‚É£ Clean up extra spaces
  return t.trim().replace(/\s+/g, " ");
}


let currentTable="", currentData=[], dropdownData={};const rowStatus = {};// Current active status map for rows
const activeStatusMap = {}; // key = row id, value = true/false
 // tableName_rowId = true/false
// -------------------------------------------------------------
// üî• UNIVERSAL NAME RESOLVER ‚Äî converts IDs ‚Üí Names everywhere
// -------------------------------------------------------------
function resolveName(field, value) {
  if (!value) return "";

  switch (field) {

    case "ORGANIZATION_ID":
      return dropdownData.orgs?.find(o => o.ORGANIZATION_ID == value)?.ORGANIZATION_NAME || value;

    case "CENTRE_ID":
      return dropdownData.centres?.find(c => c.CENTRE_ID == value)?.CENTRE_NAME || value;

    case "CATEGORY_ID":
      return dropdownData.devicescategory?.find(c => c.CATEGORY_ID == value)?.CATEGORY_NAME || value;

    case "DEVICE_ID":
    case "Device_ID":
      return dropdownData.devices?.find(d => d.DEVICE_ID == value)?.DEVICE_NAME || value;

    case "SENSOR_ID":
      return dropdownData.sensors?.find(s => s.SENSOR_ID == value)?.SENSOR_NAME || value;

    case "PARAMETER_ID":
      return dropdownData.parameters?.find(p => p.PARAMETER_ID == value)?.PARAMETER_NAME || value;

    case "UOM_ID":
      return dropdownData.uoms?.find(u => u.UOM_ID == value)?.UOM_NAME || value;

    case "Subscription_ID":
      return dropdownData.mastersubscriptioninfo?.find(s => s.Subscription_ID == value)?.Package_Name || value;

    case "Plan_ID":
      return dropdownData.masterplantype?.find(p => p.Plan_ID == value)?.Plan_Name || value;

    case "USER_ID":
      return dropdownData.user?.find(u => u.USER_ID == value)?.USERNAME || value;

    case "ROLE_ID":
      return dropdownData.roles?.find(r => r.ROLE_ID == value)?.ROLE_NAME || value;

    case "CREATED_BY":
      let u = dropdownData.user?.find(x => x.USER_ID == value);
      if (!u) return "‚Äî";
      let r = dropdownData.roles?.find(x => x.ROLE_ID == u.ROLE_ID);
      return r ? r.ROLE_NAME : "‚Äî";

    default:
      return value;
  }
}

function openSummaryPopup(type) {
    const data = window.summaryData[type];
    let title = "";
    let body = "";

 if (type === "organizations") {
    title = "ORGANIZATIONS";

    body = `
        <div class="popup-heading">${title}</div>
        <div class="popup-divider"></div>

        ${data.map(o => `
            <div class="popup-item">
                <i class="bi bi-building popup-icon"></i>
                <span class="popup-text">${o.ORGANIZATION_NAME}</span>
            </div>
        `).join("")}
    `;
}



if (type === "devices") {
    title = "All Devices";

    body = `
<style>
.modal-content {
    border-radius: 18px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    overflow: hidden;
}

/* Table wrapper */
.pro-table {
    border-radius: 12px;
    overflow: hidden;
    border: none;
}

/* Header */
.pro-table thead th {
    background: linear-gradient(90deg, #343a40, #495057);
    color: #fff;
    padding: 12px;
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
    border: none !important;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Cells */
.pro-table td {
    padding: 12px 14px;
    font-size: 15px;
    vertical-align: middle;
}

/* Alternating rows */
.pro-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.pro-table tbody tr:nth-child(odd) {
    background: #ffffff;
}

/* Hover */
.pro-table tbody tr:hover {
    background: #eaf4ff !important;
    cursor: pointer;
    transition: 0.2s ease-in-out;
}

/* Badges */
.status-badge {
    padding: 5px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    display: inline-block;
}

.badge-active {
    background: #2ecc71;
    color: white;
}

.badge-expired {
    background: #e74c3c;
    color: white;
}

.badge-none {
    background: #95a5a6;
    color: white;
}

/* Modal Body Padding */
.modal-body {
    padding: 25px !important;
    background: #fdfdfd;
}
</style>
    <div class="table-responsive">
      <table class="table pro-table table-hover">
        <thead>
          <tr>
            <th>Device Name</th>
            <th>Organization</th>
            <th>Centre</th>
            <th>Plan Type</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody>
          ${data.map(d => {

            const org = dropdownData.orgs?.find(o => String(o.ORGANIZATION_ID) === String(d.ORGANIZATION_ID));
            const cen = dropdownData.centres?.find(c => String(c.CENTRE_ID) === String(d.CENTRE_ID));

            const sub = dropdownData.mastersubscriptionhistory
              ?.filter(s => String(s.Device_ID) === String(d.DEVICE_ID))
              ?.sort((a,b) => new Date(b.Subscription_Start_date) - new Date(a.Subscription_Start_date))[0];

            const plan = dropdownData.masterplantype?.find(p => p.Plan_ID == sub?.Plan_ID);

            const start = sub?.Subscription_Start_date ?? "-";
            const end   = sub?.Subcription_End_date ?? "-";
            const planName = plan ? `${plan.Plan_Name} (${plan.Plan_ID})` : "-";

            let badge = `<span class="status-badge badge-none">No Plan</span>`;

            if (end !== "-") {
                const today = new Date();
                const endDate = new Date(end);
                const diff = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

                if (diff >= 0) {
                    badge = `<span class="status-badge badge-active">${diff} Days Left</span>`;
                } else {
                    badge = `<span class="status-badge badge-expired">Expired</span>`;
                }
            }

            return `
              <tr>
                <td><b>${d.DEVICE_NAME}</b> <small class="text-muted">(${d.DEVICE_ID})</small></td>
                <td>${org ? `${org.ORGANIZATION_NAME} (${org.ORGANIZATION_ID})` : "-"}</td>
                <td>${cen ? `${cen.CENTRE_NAME} (${cen.CENTRE_ID})` : "-"}</td>
                <td>${planName}</td>
                <td>${start}</td>
                <td>${end}</td>
                <td>${badge}</td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>
    </div>
    `;
}




    if (type === "online") {
    title = "Online Devices";

    body = data.map(s => {

        const device = dropdownData.devices.find(d => d.DEVICE_ID == s.DEVICE_ID);

        // latest reading
        const read = window.summaryData.readings
            .filter(r => r.DEVICE_ID == s.DEVICE_ID)
            .sort((a,b) => new Date(b.RAISED_TIME) - new Date(a.RAISED_TIME))[0];

        // latest alarm
        const alarm = window.summaryData.alarms
            .filter(r => r.DEVICE_ID == s.DEVICE_ID)
            .sort((a,b) => new Date(b.RAISED_TIME) - new Date(a.RAISED_TIME))[0];

        return `
        <div class="popup-item">
            <div>
                <strong>${device?.DEVICE_NAME}</strong><br>
                Status: <span class="text-success">ONLINE</span><br>
                Reading: ${read ? read.READING : "‚Äî"}<br>
                Alarm: ${alarm ? alarm.MESSAGE : "‚Äî"}<br>
                Updated: ${s.updated_at}
            </div>
        </div>
        <div class="popup-divider"></div>
        `;
    }).join("");
}


    if (type === "offline") {
    title = "Offline Devices";

    body = window.summaryData.offline.map(d => `
        <div class="popup-item">
            <strong>Device ID: ${d.DEVICE_ID}</strong><br>
            Status: <span class="text-danger">OFFLINE</span><br>
            Updated: ${d.UPDATED_ON_DATE ?? "‚Äî"} ${d.UPDATED_ON_TIME ?? ""}
        </div>
        <div class="popup-divider"></div>
    `).join("");
}


    showPopup(title, body);
} //for offline and online devices//

function showPopup(title, content) {
  const existing = document.getElementById("summaryPopup");
  if (existing) existing.remove();

  const popup = `
    <div class="modal fade" id="summaryPopup" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg" style="border-radius: 16px;">
          
          <div class="modal-header" style="border-bottom: 1px solid #eee;">
            <h5 class="modal-title fw-semibold">${title}</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          
          <div class="modal-body">
            ${content}
          </div>

        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML("beforeend", popup);
  new bootstrap.Modal(document.getElementById("summaryPopup")).show();
}


// ===== preload dropdown datasets =====
async function loadDropdowns(){
  try{
    dropdownData.orgs    = await fetchJSON(API.masterorganizations);
    dropdownData.centres = await fetchJSON(API.mastercentre);
    dropdownData.uoms    = await fetchJSON(API.masteruom);
    dropdownData.devices = await fetchJSON(API.masterdevices);
    dropdownData.sensors = await fetchJSON(API.mastersensor);
    dropdownData.parameters = await fetchJSON(API.masterparameter);
    dropdownData.roles   = await fetchJSON(API.masterrole);
    dropdownData.user   = await fetchJSON(API.createuser);
    dropdownData.devicescategory = await fetchJSON(API.devicescategory);
    dropdownData.mastersubscriptioninfo = await fetchJSON(API.mastersubscriptioninfo);
    dropdownData.masterplantype = await fetchJSON(API.masterplantype);
    dropdownData.mastersubscriptionhistory = await fetchJSON(API.mastersubscriptionhistory);
    dropdownData.devicestatusalarmlog = await fetchJSON(API.devicestatusalarmlog);

  }catch(err){
    console.error("Dropdown preload failed:", err);
  }
}

function sortDescending(table, data) {
  if (!data || data.length === 0) return data;

  const sample = data[0];

  // Date/Time fields check
  const dateKeys = Object.keys(sample).filter(k => k.toLowerCase().includes("date") || k.toLowerCase().includes("time"));
  if (dateKeys.length) {
    // Sort by first date/time field
    const key = dateKeys[0];
    return data.sort((a, b) => new Date(b[key]) - new Date(a[key]));
  }

  // Numeric fields check (ID, reading, etc.)
  const numberKeys = Object.keys(sample).filter(k => typeof sample[k] === "number" || !isNaN(Number(sample[k])));
  if (numberKeys.length) {
    const key = numberKeys[0];
    return data.sort((a, b) => Number(b[key]) - Number(a[key]));
  }

  return data; // fallback: as is
}


// ===== load & draw table =====
async function loadTable(table) {
  currentTable = normalizeKey(table);

 // ‚úÖ Show the tableSection whenever a table is loaded
  document.getElementById("tableSection").style.display = "block";

  if (!API[currentTable]) {
    console.error("No API for:", table, currentTable);
    return;
  }

  document.getElementById('tableTitle').innerText = formatTitle(table);

  try {
    currentData = await fetchJSON(API[currentTable]);

    // ‚úÖ Apply generic descending sort for all tables
    currentData = sortDescending(currentTable, currentData);

    // ‚úÖ Sorting for readings & alarms
    if (currentTable === "devicereadinglog") {
      if (currentData.length > 0 && currentData[0].READING_DATE && currentData[0].READING_TIME) {
        currentData.sort((a, b) => new Date(b.READING_DATE + " " + b.READING_TIME) - new Date(a.READING_DATE + " " + a.READING_TIME));
      } else if (currentData.length > 0 && currentData[0].READING !== undefined) {
        currentData.sort((a, b) => b.READING - a.READING);
      }
    }

if (currentTable === "devicealarmlog") {
  currentData.sort((a, b) => {
    const aDateTime = new Date(
      (a.ALARM_DATE || a.CREATED_DATE || a.DATE || '') + " " + (a.ALARM_TIME || a.CREATED_TIME || '')
    );
    const bDateTime = new Date(
      (b.ALARM_DATE || b.CREATED_DATE || b.DATE || '') + " " + (b.ALARM_TIME || b.CREATED_TIME || '')
    );
    
    // If both valid dates, compare normally
    if (!isNaN(aDateTime) && !isNaN(bDateTime)) {
      return bDateTime - aDateTime; // latest first
    }

    // fallback: compare ID or reading if dates invalid
    if (a.S_NO && b.S_NO) return b.S_NO - a.S_NO;
    if (a.READING && b.READING) return b.READING - a.READING;
    return 0;
  });
}


  } catch (err) {
    console.error("Fetch table failed:", err);
    currentData = [];
  }

  function sortDescending(table, data) {
  if (!data || data.length === 0) return data;

  // ‚úÖ mastersubscriptionhistory: latest entry first
  if (table === "mastersubscriptionhistory") {
    // Prefer ID-based DESC (most reliable)
    if (data[0].id) {
      return data.sort((a, b) => b.id - a.id);
    }
    // Fallback to date if ID not found
    return data.sort((a, b) => new Date(b.Subscription_Start_date) - new Date(a.Subscription_Start_date));
  }

  // ‚úÖ Default sort logic for others
  const sample = data[0];
  const dateKeys = Object.keys(sample).filter(k =>
    k.toLowerCase().includes("date") || k.toLowerCase().includes("time")
  );
  if (dateKeys.length) {
    const key = dateKeys[0];
    return data.sort((a, b) => new Date(b[key]) - new Date(a[key]));
  }

  const numberKeys = Object.keys(sample).filter(
    k => typeof sample[k] === "number" || !isNaN(Number(sample[k]))
  );
  if (numberKeys.length) {
    const key = numberKeys[0];
    return data.sort((a, b) => Number(b[key]) - Number(a[key]));
  }

  return data;
}

  const tableEl = document.getElementById('mainTable');
  const thead = tableEl.querySelector('thead');
  const tbody = tableEl.querySelector('tbody');
  thead.innerHTML = tbody.innerHTML = "";

  let headers = currentData.length ? Object.keys(currentData[0]) : (FIELD_SCHEMAS[currentTable] || []);
  const pk = PRIMARY_KEYS[currentTable] || headers[0];

  // // ‚úÖ Add extra ID field for master tables
  // if (currentTable === "masterdevices" && !headers.includes("DEVICE_ID")) headers.push("DEVICE_ID");
  // if (currentTable === "mastersensor" && !headers.includes("SENSOR_ID")) headers.push("SENSOR_ID");
  // if (currentTable === "masterparameter" && !headers.includes("PARAMETER_ID")) headers.push("PARAMETER_ID");
  

  // ‚úÖ Render table headers with friendly names
const displayHeaders = headers
  // .filter(h => !(currentTable === "createuser" && h === "IS_ACTIVE"))   // üî• REMOVE IS_ACTIVE COLUMN
  .map(h => {
    if ([
      "masterorganizations","mastercentre","masterdevices","mastersensor",
      "masterparameter","masteruom","createuser","masterrole",
      "sensorparameterlink","devicesensorlink","userorganizationcentrelink",
      "masternotificationtime","devicescategory","devicealarmlog",
      "devicereadinglog","mastersubscriptioninfo","masterplantype",
      "mastersubscriptionhistory"
    ].includes(currentTable) && h === pk) {
      return "S_NO";
    }
    return HEADER_LABELS[h] || h;
  });


  // ‚úÖ Add extra header for master IDs
if (currentTable === "masterdevices") displayHeaders.push("DEVICE_ID");
if (currentTable === "mastersensor") displayHeaders.push("SENSOR_ID");
if (currentTable === "masterparameter") displayHeaders.push("PARAMETER_ID");
if (currentTable === "masterorganizations") displayHeaders.push("ORGANIZATION_ID");
if (currentTable === "mastercentre") displayHeaders.push("CENTRE_ID");
  thead.innerHTML = `<tr>${
    displayHeaders.filter((h,i) => headers[i] !== "PASSWORD").map(h => `<th>${h}</th>`).join("")
  }${ (currentTable === "devicealarmlog" || currentTable === "devicereadinglog") ? "" : "<th>Actions</th>" }
   </tr>`;

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const options = { year: "numeric", month: "short", day: "2-digit" };
    return new Date(dateStr).toLocaleDateString("en-GB", options);
  }

  // ----- Render table body -----
  // ----- Render table body -----
if (currentData.length) {
  tbody.innerHTML = currentData.map((row, rowIdx) => {

   let rowCells = headers
  .filter(h => h !== "PASSWORD" && !(currentTable === "createuser" && h === "IS_ACTIVE"))
.map(h => {

    // =====================
    // 1Ô∏è‚É£ S_NO numbering
    // =====================
    if (
        h === pk &&
        [
            "sensorparameterlink",
            "devicesensorlink",
            "masterorganizations","mastercentre","masterdevices",
            "mastersensor","masterparameter","masteruom",
            "createuser","masterrole","userorganizationcentrelink",
            "masternotificationtime","devicescategory",
            "devicereadinglog","devicealarmlog",
            "mastersubscriptioninfo","masterplantype",
            "mastersubscriptionhistory"
        ].includes(currentTable)
    ) {
        return `<td>${rowIdx + 1}</td>`;
    }

    // ===========================================================
    // 2Ô∏è‚É£ SPECIAL FORMATTING ‚Üí MUST RUN BEFORE DEFAULT RETURN
    // ===========================================================

    // üåü SENSOR PARAMETER LINK (show NAME + ID)
    if (currentTable === "sensorparameterlink") {

        if (h === "SENSOR_ID") {
            const s = dropdownData.sensors?.find(x => x.SENSOR_ID == row[h]);
            return `<td>${s ? `${s.SENSOR_NAME} (${s.SENSOR_ID})` : row[h]}</td>`;
        }

        if (h === "PARAMETER_ID") {
            const p = dropdownData.parameters?.find(x => x.PARAMETER_ID == row[h]);
            return `<td>${p ? `${p.PARAMETER_NAME} (${p.PARAMETER_ID})` : row[h]}</td>`;
        }
    }

    // üåü DEVICE SENSOR LINK (show NAME + ID)
    if (currentTable === "devicesensorlink") {

        if (h === "DEVICE_ID") {
            const d = dropdownData.devices?.find(x => x.DEVICE_ID == row[h]);
            return `<td>${d ? `${d.DEVICE_NAME} (${d.DEVICE_ID})` : row[h]}</td>`;
        }

        if (h === "SENSOR_ID") {
            const s = dropdownData.sensors?.find(x => x.SENSOR_ID == row[h]);
            return `<td>${s ? `${s.SENSOR_NAME} (${s.SENSOR_ID})` : row[h]}</td>`;
        }

        if (h === "ORGANIZATION_ID") {
            const o = dropdownData.orgs?.find(x => x.ORGANIZATION_ID == row[h]);
            return `<td>${o ? `${o.ORGANIZATION_NAME} (${o.ORGANIZATION_ID})` : row[h]}</td>`;
        }

        if (h === "CENTRE_ID") {
            const c = dropdownData.centres?.find(x => x.CENTRE_ID == row[h]);
            return `<td>${c ? `${c.CENTRE_NAME} (${c.CENTRE_ID})` : row[h]}</td>`;
        }
    }

    // ===============================
    // 3Ô∏è‚É£ DEFAULT NAME MAPPING
    // ===============================
    // let cellVal = resolveName(h, row[h]);
    let rawVal = row[h];
let cellVal = (rawVal === 0 || rawVal === "0") ? "0" : resolveName(h, rawVal);


    // Boolean fields
    if (h === "SEND_SMS" || h === "SEND_EMAIL") {
        cellVal = row[h] ? "Yes" : "No";
    }

    // Created by ‚Üí Role
    if (h === "CREATED_BY") {
        const creator = dropdownData.user?.find(u => u.USER_ID == row[h]);
        const roleObj = dropdownData.roles?.find(r => r.ROLE_ID == creator?.ROLE_ID);
        cellVal = roleObj ? roleObj.ROLE_NAME : "‚Äî";
    }
     // üî•üî• DEVICE_STATUS (THIS WAS NOT WORKING BEFORE)
        if (h === "DEVICE_STATUS") {
    cellVal = row.DEVICE_STATUS ?? "";   // show 1/0 exactly
    return `<td>${cellVal}</td>`;
}
if (h === "SENSOR_STATUS") {
    cellVal = row.SENSOR_STATUS ?? "";   // show 1/0 exactly
    return `<td>${cellVal}</td>`;
}

if (h === "created_by") {
    const creator = dropdownData.user?.find(u => u.USER_ID == row[h]);
    const roleObj = dropdownData.roles?.find(r => r.ROLE_ID == creator?.ROLE_ID);
    cellVal = roleObj ? roleObj.ROLE_NAME : "‚Äî";
}

    return `<td>${cellVal}</td>`;
 // to show id of device,sensor, parameter etc 

      // Map IDs ‚Üí Names
      if (h === "ORG_ID" || h === "ORGANIZATION_ID") {
        const org = (dropdownData.orgs || []).find(o => o.ORGANIZATION_ID == row[h]);
        cellVal = org ? org.ORGANIZATION_NAME : row[h];
      }
      if (h === "CENTRE_ID") {
        const centre = (dropdownData.centres || []).find(c => c.CENTRE_ID == row[h]);
        cellVal = centre ? centre.CENTRE_NAME : row[h];
      }
      if (h === "CATEGORY_ID") {
        const cat = (dropdownData.devicescategory || []).find(dc => dc.CATEGORY_ID == row[h]);
        cellVal = cat ? cat.CATEGORY_NAME : row[h];
      }
      if (h === "DEVICE_ID" && currentTable !== "masterdevices") {
        const device = (dropdownData.devices || []).find(d => d.DEVICE_ID == row[h]);
        cellVal = device ? device.DEVICE_NAME : row[h];
      }
      if (h === "Device_ID") {
        const device = (dropdownData.devices || []).find(d => d.DEVICE_ID == row[h]);
        cellVal = device ? device.DEVICE_NAME : row[h];
      }
      
      if (h === "SENSOR_ID" && currentTable !== "mastersensor") {
        const sensor = (dropdownData.sensors || []).find(s => s.SENSOR_ID == row[h]);
        cellVal = sensor ? sensor.SENSOR_NAME : row[h];
      }
      if (h === "PARAMETER_ID" && currentTable !== "masterparameter") {
        const param = (dropdownData.parameters || []).find(p => p.PARAMETER_ID == row[h]);
        cellVal = param ? param.PARAMETER_NAME : row[h];
      }
      if (h === "USER_ID") {
        const user = (dropdownData.user || []).find(u => u.USER_ID == row[h]);
        cellVal = user ? user.USERNAME : row[h];
      }
      if (h === "ROLE_ID") {
        const role = (dropdownData.roles || []).find(r => r.ROLE_ID == row[h]);
        cellVal = role ? role.ROLE_NAME : row[h];
      }
      if (h === "UOM_ID") {
        const uom = (dropdownData.uoms || []).find(u => u.UOM_ID == row[h]);
        cellVal = uom ? uom.UOM_NAME : row[h];
      }

      if (h === "Subscription_ID") {
        const pkg = (dropdownData.mastersubscriptioninfo || []).find(p => p.Subscription_ID == row[h]);
        cellVal = pkg ? pkg.Package_Name : row[h];
      }

      if (h === "Plan_ID") {
        const plan = (dropdownData.masterplantype || []).find(p => p.Plan_ID == row[h]);
        cellVal = plan ? plan.Plan_Name : row[h];
}


      // Format date
      if (/^\d{4}-\d{2}-\d{2}$/.test(cellVal)) {
        const options = { year: "numeric", month: "short", day: "2-digit" };
        cellVal = new Date(cellVal).toLocaleDateString("en-GB", options);
      }

      return `<td>${cellVal}</td>`;
    }).join("");

    // ‚úÖ Manually append ID column for master tables
    if (currentTable === "masterdevices") rowCells += `<td>${row.DEVICE_ID || ""}</td>`;
    if (currentTable === "mastersensor") rowCells += `<td>${row.SENSOR_ID || ""}</td>`;
    if (currentTable === "masterparameter") rowCells += `<td>${row.PARAMETER_ID || ""}</td>`;
    if (currentTable === "mastercentre") rowCells += `<td>${row.CENTRE_ID || ""}</td>`;
    if (currentTable === "masterorganizations") rowCells += `<td>${row.ORGANIZATION_ID || ""}</td>`;




    const addBtn = document.getElementById("addBtn");
    if (currentTable === "devicereadinglog" || currentTable === "devicealarmlog") {
      addBtn.style.display = "none";
    } else {
      addBtn.style.display = "inline-block";
    }

    const idVal = row[pk];
    const noActions = (currentTable === "devicealarmlog" || currentTable === "devicereadinglog");

if (currentTable === "mastersubscriptionhistory") {
  return `<tr class="${row.Status === 'Expired' ? 'expired-row' : ''}">${rowCells}${noActions ? "" : `
    <td>
      <button class="btn btn-sm btn-warning" onclick='editRow(${JSON.stringify(row)})'><i class="bi bi-pencil"></i></button>
      <button class="btn btn-sm btn-success" onclick='renew(${JSON.stringify(idVal)})'>Renew</button>
    </td>`}
  </tr>`;  
}

if (currentTable === "masterdevices") {
  return `<tr class="${row.DEVICE_STATUS === 1 ? '' : 'inactive-row'}">
    ${rowCells}${noActions ? "" : `
      <td>
        <button class="btn btn-sm btn-warning me-2" onclick='editRow(${JSON.stringify(row)})'>
          <i class="bi bi-pencil"></i>
        </button>
        <label class="switch">
          <input type="checkbox" ${row.DEVICE_STATUS === 1 ? "checked" : ""} 
            onchange="toggleActiveStatus(${row.DEVICE_ID}, this)">
          <span class="slider round">
            <span class="status-text">${row.DEVICE_STATUS === 1 ? "Active" : "Inactive"}</span>
          </span>
        </label>
      </td>`}
  </tr>`;
}

if (currentTable === "mastersensor") {
  return `<tr class="${row.SENSOR_STATUS === 1 ? '' : 'inactive-row'}">
    ${rowCells}${noActions ? "" : `
      <td>
        <button class="btn btn-sm btn-warning me-2" onclick='editRow(${JSON.stringify(row)})'>
          <i class="bi bi-pencil"></i>
        </button>
        <label class="switch">
          <input type="checkbox" ${row.SENSOR_STATUS === 1 ? "checked" : ""} 
            onchange="toggleSensorStatus(${row.SENSOR_ID}, this)">
          <span class="slider round">
            <span class="status-text">${row.SENSOR_STATUS === 1 ? "Active" : "Inactive"}</span>
          </span>
        </label>
      </td>`}
  </tr>`;
}

// if (currentTable === "createuser") {
//   const active = (String(row.IS_ACTIVE) === "1" || String(row.IS_ACTIVE).toLowerCase() === "true");

//   return `<tr class="${active ? '' : 'inactive-row'}">
//     ${rowCells}
//     <td>
//       <button class="btn btn-sm btn-warning me-2" onclick='editRow(${JSON.stringify(row)})'>
//         <i class="bi bi-pencil"></i>
//       </button>

//       <label class="switch">
//         <input type="checkbox" ${active ? "checked" : ""} 
//           onchange="toggleUserStatus(${row.USER_ID}, this)">
//         <span class="slider round">
//           <span class="status-text">${active ? "Active" : "Inactive"}</span>
//         </span>
//       </label>
//     </td>
//   </tr>`;
// }

    return `<tr>${rowCells}${noActions ? "" : `
      <td>
        <button class="btn btn-sm btn-warning" onclick='editRow(${JSON.stringify(row)})'><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-danger" onclick='deleteRow(${JSON.stringify(idVal)})'><i class="bi bi-trash"></i></button>
      </td>`}
    </tr>`;
  }).join("");
} else {
  if (headers.length) {
    tbody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center text-muted">No records found</td></tr>`;
  }
}


  const section = document.getElementById("tableSection");
  if (section) {
    section.scrollIntoView({ behavior: "smooth" });
  }
}
// ===== Modal =====
function addRow(){ openModal({}); }
function editRow(row){ openModal(row); }

function formatFirstWord(str){
  str = str.trimStart();
  if(!str) return "";
  let parts = str.split(" ");
  parts[0] = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
  return parts.join(" ");
}

function openModal(row){
}

async function openModal(row ={}){
  await loadDropdowns(); 
  const modalEl = document.getElementById('crudModal');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();

  const isEdit = Object.keys(row).length > 0;
  document.getElementById('modalTitle').innerText = (isEdit?"Edit ":"Add ") + formatTitle(currentTable);

  const submitBtn = document.querySelector('#crudForm button[type="submit"]');
  submitBtn.innerHTML = isEdit ? `<i class="bi bi-check2"></i> Update` : `<i class="bi bi-check2"></i> Save`;

  const fieldsDiv = document.getElementById('modalFields');
  fieldsDiv.innerHTML = "";

 if (currentTable === "devicesensorlink") {
  const getDropdown = (name, data, valueKey, labelKey) => {
    // Sort by valueKey descending (latest first)
    const sortedData = [...data].sort((a, b) => b[valueKey] - a[valueKey]);

    return `
      <div class="mb-3">
        <label class="form-label">${name.toUpperCase()}</label>
        <select class="form-select" name="${name}_ID">
          <option value="">-- Choose ${name.toLowerCase()} --</option>
          ${sortedData.map(item => `
            <option value="${item[valueKey]}" ${row?.[`${name}_ID`] == item[valueKey] ? 'selected' : ''}>
              ${item[labelKey]}
            </option>
          `).join('')}
        </select>
      </div>
    `;
  };

  fieldsDiv.innerHTML = `
    <input type="hidden" name="${PRIMARY_KEYS[currentTable]}" value="${row?.[PRIMARY_KEYS[currentTable]] ?? ''}">
    ${getDropdown('DEVICE', dropdownData.devices, 'DEVICE_ID', 'DEVICE_NAME')}
    ${getDropdown('SENSOR', dropdownData.sensors, 'SENSOR_ID', 'SENSOR_NAME')}
  `;

  return; // stop execution here, generic code won't run
}


if (currentTable === "createuser") {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const formattedToday = `${yyyy}-${mm}-${dd}`; // ‚úÖ yyyy-mm-dd for input[type=date]

  // ‚úÖ default validity end = +1 saal
  const nextYear = new Date(today);
  nextYear.setFullYear(today.getFullYear() + 1);
  const yyyyEnd = nextYear.getFullYear();
  const mmEnd = String(nextYear.getMonth() + 1).padStart(2, "0");
  const ddEnd = String(nextYear.getDate()).padStart(2, "0");
  const formattedEnd = `${yyyyEnd}-${mmEnd}-${ddEnd}`;

  fieldsDiv.innerHTML = `
    <input type="hidden" name="USER_ID" value="${row.USER_ID ?? ''}">
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Actual Name</label>
        <input type="text" class="form-control" name="ACTUAL_NAME" value="${row.ACTUAL_NAME ?? ''}">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Username</label>
       <input type="text" class="form-control" id="USERNAME" name="USERNAME" value="${row.USERNAME ?? ''}">
      <small id="usernameError" class="text-danger fw-bold"></small>
      </div>
<div class="col-md-6 mb-3">
  <label class="form-label">Role</label>
  <select class="form-select" name="ROLE_ID">
    <option value="">-- Choose Role --</option>
    ${(dropdownData.roles || []).map(r => `
      <option value="${r.ROLE_ID}" ${(String(r.ROLE_ID) === String(row.ROLE_ID ?? row.ROLE ?? "")) ? "selected" : ""}>
        ${r.ROLE_NAME}
      </option>
    `).join("")}
  </select>
</div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Phone</label>
        <input type="text" class="form-control" name="PHONE" value="${row.PHONE ?? ''}">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" name="SEND_SMS" ${row.SEND_SMS ? "checked" : ""}>
          <label class="form-check-label">Send SMS</label>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="EMAIL" value="${row.EMAIL ?? ''}">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" name="SEND_EMAIL" ${row.SEND_EMAIL ? "checked" : ""}>
          <label class="form-check-label">Send Email</label>
        </div>
      </div>

   <div class="col-md-6 mb-3">
        <label class="form-label">Password</label>
        <input type="password" class="form-control" id="PASSWORD" name="PASSWORD" value="${row.PASSWORD ?? ''}">
        <div id="PASSWORD-error" class="text-danger mt-1"></div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox"  id="showPassword">
          <label class="form-check-label" for="showPassword">Show Password</label>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Confirm Password</label>
        <input type="password" class="form-control" id="confirm_password" name="confirm_password" value="${row.PASSWORD ?? ''}">
        <div id="confirm_password-error" class="text-danger mt-1"></div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="showConfirmPassword">
          <label class="form-check-label" for="showConfirmPassword">Show Confirm Password</label>
        </div>
      </div>

      <!-- Validity fields -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Validity Start</label>
        <input type="date" class="form-control" name="VALIDITY_START" value="${row.VALIDITY_START ?? formattedToday}">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Validity End</label>
        <input type="date" class="form-control" name="VALIDITY_END" value="${row.VALIDITY_END ?? formattedEnd}">
      </div>
    </div>
  `;

  // Show/Hide password logic
  setTimeout(() => {
    document.getElementById("showPassword")?.addEventListener("change", function() {
      document.getElementById("PASSWORD").type = this.checked ? "text" : "password";
    });
    document.getElementById("showConfirmPassword")?.addEventListener("change", function() {
      document.getElementById("confirm_password").type = this.checked ? "text" : "password";
    });

    // Password validation on input
    const passwordInput = document.getElementById("PASSWORD");
    const confirmInput = document.getElementById("confirm_password");

    function validatePassword() {
      const value = passwordInput.value;
      const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
      const errorEl = document.getElementById("PASSWORD-error");

      if (!regex.test(value)) {
        errorEl.textContent = "Password must be min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char.";
      } else {
        errorEl.textContent = "";
      }

      // Confirm password match
      const confirmEl = document.getElementById("confirm_password-error");
      if (confirmInput.value && value !== confirmInput.value) {
        confirmEl.textContent = "Passwords do not match.";
      } else {
        confirmEl.textContent = "";
      }
    }

    passwordInput.addEventListener("input", validatePassword);
    confirmInput.addEventListener("input", validatePassword);
  
        const usernameInput = document.getElementById("USERNAME");
    const usernameError = document.getElementById("usernameError");

    usernameInput.addEventListener("input", function () {
      const username = this.value.trim();
      if (!username) {
        usernameError.textContent = "";
        usernameInput.style.border = "";
        return;
      }

      const exists = (dropdownData.user || []).some(
        u => u.USERNAME.toLowerCase() === username.toLowerCase()
      );

      if (exists) {
        usernameError.textContent = "‚ö† Username already taken";
        usernameError.className = "text-danger fw-bold";
        usernameInput.style.border = "2px solid red";
      } else {
        usernameError.textContent = "‚úî Username available";
        usernameError.className = "text-success fw-bold";
        usernameInput.style.border = "2px solid green";
      }
    });
  
  }, 100);
  

  return;
}



  const schema = currentData.length ? Object.keys(currentData[0]) : (FIELD_SCHEMAS[currentTable] || []);
  const pk = PRIMARY_KEYS[currentTable];

  schema.forEach(key => {
      // mastersensor ka SENSOR_STATUS add/edit form me skip
  if (currentTable === "mastersensor" && key === "SENSOR_STATUS") return;
  if (currentTable === "masterdevices" && key === "DEVICE_STATUS") return;
  if (currentTable === "mastersubscriptionhistory" && key === "Status") return;
  // if (currentTable === "createuser" && key === "IS_ACTIVE") return;
  // if (key === "created_by") return;



  let fieldHtml = "";
    // PK handling
 if(key === pk){
  // if(currentTable === "userorganizationcentrelink"){
  //   return;  // add + edit dono me skip
  // }
  fieldsDiv.innerHTML += `<input name="${key}" value="${row[key]??''}" hidden>`;
  return;
}



    

// Organization dropdown
if (key === "ORG_ID" || key === "ORGANIZATION_ID") {
  const options = (dropdownData.orgs || []).sort((a, b) => b.ORGANIZATION_ID - a.ORGANIZATION_ID);
  fieldsDiv.innerHTML += `<div class="mb-3">
    <label class="form-label">ORGANIZATION</label>
    <select class="form-select" name="${key}">
      <option value="">-- Choose Organization --</option>
      ${options.map(o => `<option value="${o.ORGANIZATION_ID}" ${o.ORGANIZATION_ID == (row[key] ?? "") ? 'selected' : ''}>${o.ORGANIZATION_NAME}</option>`).join("")}
    </select>
  </div>`;
  return;
}

// Centre dropdown
if (key === "CENTRE_ID") {
  const options = (dropdownData.centres || []).sort((a, b) => b.CENTRE_ID - a.CENTRE_ID);
  fieldsDiv.innerHTML += `<div class="mb-3">
    <label class="form-label">CENTRE</label>
    <select class="form-select" name="CENTRE_ID">
      <option value="">-- Choose Centre --</option>
      ${options.map(c => `<option value="${c.CENTRE_ID}" ${c.CENTRE_ID == (row["CENTRE_ID"] || "") ? 'selected' : ''}>${c.CENTRE_NAME}</option>`).join('')}
    </select>
  </div>`;
  return;
}

// UOM dropdown
if (key === "UOM_ID") {
  const options = (dropdownData.uoms || []).sort((a, b) => b.UOM_ID - a.UOM_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">UNIT</label>
      <select class="form-select" name="UOM_ID">
        <option value="">-- Choose UOM --</option>
        ${options.map(o => `<option value="${o.UOM_ID}" ${(o.UOM_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.UOM_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

// Device dropdown
if (key === "DEVICE_ID") {
  const options = (dropdownData.devices || []).sort((a, b) => b.DEVICE_ID - a.DEVICE_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">DEVICE</label>
      <select class="form-select" name="DEVICE_ID">
        <option value="">-- Choose Device --</option>
        ${options.map(o => `<option value="${o.DEVICE_ID}" ${(o.DEVICE_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.DEVICE_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

if (key === "Device_ID") {
  const options = (dropdownData.devices || []).sort((a, b) => b.DEVICE_ID - a.DEVICE_ID); // ascending
  const selectOptions = options.map(o => `
    <option value="${o.DEVICE_ID}" ${o.DEVICE_ID == (row[key] ?? "") ? 'selected' : ''}>${o.DEVICE_NAME}</option>
  `).join("");

  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">DEVICE</label>
      <select class="form-select" name="Device_ID">
        <option value="">-- Choose Device --</option>
        ${selectOptions}
      </select>
    </div>`;
  return;
}


if (key === "Subscription_ID") {
  const options = (dropdownData.mastersubscriptioninfo || []).sort((a, b) => b.Subscription_ID - a.Subscription_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">Package Name</label>
      <select class="form-select" name="Subscription_ID">
        <option value="">-- Choose Package --</option>
        ${options.map(o => `<option value="${o.Subscription_ID}" ${(o.Subscription_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.Package_Name}</option>`).join("")}
      </select>
    </div>`;
  return;
}
if (key === "Plan_ID") {
  const options = (dropdownData.masterplantype || []).sort((a, b) => b.Plan_ID - a.Plan_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">Plan Type</label>
      <select class="form-select" name="Plan_ID">
        <option value="">-- Choose Plan --</option>
        ${options.map(o => `<option value="${o.Plan_ID}" ${(o.Plan_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.Plan_Name}</option>`).join("")}
      </select>
    </div>`;
  return;
}

// Sensor dropdown
if (key === "SENSOR_ID") {
  const options = (dropdownData.sensors || []).sort((a, b) => b.SENSOR_ID - a.SENSOR_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">SENSOR</label>
      <select class="form-select" name="SENSOR_ID">
        <option value="">-- Choose Sensor --</option>
        ${options.map(o => `<option value="${o.SENSOR_ID}" ${(o.SENSOR_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.SENSOR_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

// Parameter dropdown
if (key === "PARAMETER_ID") {
  const options = (dropdownData.parameters || []).sort((a, b) => b.PARAMETER_ID - a.PARAMETER_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">PARAMETER</label>
      <select class="form-select" name="PARAMETER_ID">
        <option value="">-- Choose Parameter --</option>
        ${options.map(o => `<option value="${o.PARAMETER_ID}" ${(o.PARAMETER_ID == (row[key] ?? "")) ? 'selected' : ''}>${o.PARAMETER_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

// Role dropdown
if (key === "ROLE_ID") {
  const options = (dropdownData.roles || []).sort((a, b) => b.ROLE_ID - a.ROLE_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">ROLE</label>
      <select class="form-select" name="ROLE_ID">
        <option value="">-- Choose Role --</option>
        ${options.map(r => `<option value="${r.ROLE_ID}" ${(String(r.ROLE_ID) === String(row.ROLE_ID ?? "")) ? "selected" : ""}>${r.ROLE_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

// User dropdown
if (key === "USER_ID") {
  const options = (dropdownData.user || []).sort((a, b) => b.USER_ID - a.USER_ID);
  fieldsDiv.innerHTML += `<div class="mb-3">
    <label class="form-label">USER</label>
    <select class="form-select" name="USER_ID">
      <option value="">-- Choose User --</option>
      ${options.map(u => `<option value="${u.USER_ID}" ${(u.USER_ID == (row[key] ?? "")) ? 'selected' : ''}>${u.USERNAME}</option>`).join("")}
    </select>
  </div>`;
  return;
}

// Category dropdown
if (key === "CATEGORY_ID") {
  const options = (dropdownData.devicescategory || []).sort((a, b) => b.CATEGORY_ID - a.CATEGORY_ID);
  fieldsDiv.innerHTML += `
    <div class="mb-3">
      <label class="form-label">CATEGORY</label>
      <select class="form-select" name="CATEGORY_ID">
        <option value="">-- Choose Category --</option>
        ${options.map(dc => `<option value="${dc.CATEGORY_ID}" ${(dc.CATEGORY_ID == (row[key] ?? "")) ? 'selected' : ''}>${dc.CATEGORY_NAME}</option>`).join("")}
      </select>
    </div>`;
  return;
}

    //  if(key==="ROLE_ID"){
    //   const options = dropdownData.roles || [];
    //   fieldsDiv.innerHTML += `
    //     <div class="mb-3">
    //       <label class="form-label">ROLE</label>
    //       <select class="form-select" name="ROLE_ID">
    //         <option value="">-- Choose Role  --</option>
    //         ${options.map(r=>`<option value="${r.ROLE_ID}" ${(r.ROLE_ID==(row[key]??""))?'selected':''}>${r.ROLE_NAME}</option>`).join("")}
    //       </select>
    //     </div>`;
    //   return;
    // }

// SEND_SMS / SEND_EMAIL checkbox
    if(key === "SEND_SMS" || key === "SEND_EMAIL") {
      const checked = row[key] === true || row[key] === "true" || row[key] === 1 ? "checked" : "";
      fieldsDiv.innerHTML += `
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="${key}" id="${key}" ${checked}>
          <label class="form-check-label" for="${key}">${key.replace("_"," ")}</label>
        </div>
      `;
      return;
    }

        if (key === "NOTIFICATION_TIME") {
  fieldsDiv.innerHTML += `<div class="mb-3">
    <label class="form-label">Notification Time (in seconds)</label>
    <input type="number" class="form-control" name="NOTIFICATION_TIME" 
      value="${row[key] ?? ""}" placeholder="Enter time in seconds" required>
  </div>`;
  return;
}



    // Default input field
    let type="text";
    const k = key.toLowerCase();
    if(k.includes("email")) type="email";
    else if(k.includes("password")) type="password";
    else if(k.includes("validity_start") || k.includes("validity_end")) type="date";
    else if(k.includes("date"))
  type = "date";
else if(k.endsWith("_at") || k.endsWith("_time"))
  type = "datetime-local";

  else if (k.includes("upper") || k.includes("lower") || k.includes("value") || 
         k.includes("threshold") || k.endsWith("_id"))
    type = "number";

let stepAttr = "";
if (type === "number") {
    stepAttr = `step="any"`;   // allow decimals like 4.5, 8.75, etc.
}

fieldsDiv.innerHTML += `
  <div class="mb-3">
    <label class="form-label">${key}</label>
    <input class="form-control"
           name="${key}"
           value="${row[key] ?? ''}"
           type="${type}"
           ${stepAttr}>
  </div>`;
  })

  // ===== Dependent dropdown logic (ONLY if NOT centreorganizationlink) =====
  // if(currentTable !== "centreorganizationlink"){
  //   const orgDropdownDep = fieldsDiv.querySelector('select[name="ORG_ID"], select[name="ORGANIZATION_ID"]');
  //   const centreDropdownDep = fieldsDiv.querySelector('select[name="CENTRE_ID"]');
  //   if(orgDropdownDep && centreDropdownDep){
  //     function updateCentres(){
  //       const orgId = orgDropdownDep.value;
  //       const selectedCentre = centreDropdownDep.getAttribute('data-selected-centre') || "";
  //       const filteredCentres = (dropdownData.centres || []).filter(c => c.ORGANIZATION_ID == orgId);
  //       centreDropdownDep.innerHTML = '<option value="">-- Choose Centre --</option>' +
  //         filteredCentres.map(c=>`<option value="${c.CENTRE_ID}" ${c.CENTRE_ID==selectedCentre?'selected':''}>${c.CENTRE_NAME}</option>`).join('');
  //     }
  //     if(row["CENTRE_ID"]) centreDropdownDep.setAttribute('data-selected-centre', row["CENTRE_ID"]);
  //     orgDropdownDep.addEventListener('change', ()=>{
  //       centreDropdownDep.setAttribute('data-selected-centre',''); 
  //       updateCentres();
  //     });
  //     updateCentres(); // initial populate
  //   }
  // }

 // ---- DEPENDENT DROPDOWN FOR USER-ORG-CENTRE-LINK ----
if (currentTable === "userorganizationcentrelink") {

    const orgDropdown = fieldsDiv.querySelector('select[name="ORGANIZATION_ID"]');
    const centreDropdown = fieldsDiv.querySelector('select[name="CENTRE_ID"]');

    function updateCentres() {
        const orgId = orgDropdown.value;

        // Filter centres based on selected org
        const filtered = dropdownData.centres.filter(c => 
            String(c.ORGANIZATION_ID) === String(orgId)
        );

        // Populate centre dropdown
        centreDropdown.innerHTML =
            `<option value="">-- Choose Centre --</option>` +
            filtered.map(c =>
                `<option value="${c.CENTRE_ID}" 
                    ${c.CENTRE_ID == (row.CENTRE_ID ?? "") ? 'selected' : ''}>
                    ${c.CENTRE_NAME}
                </option>`
            ).join("");
    }

    // Attach change listener
    orgDropdown.addEventListener("change", updateCentres);

    // Auto-load centres for Edit mode
    updateCentres();
}
 
}




function closeModal(){
  const modalEl = document.getElementById('crudModal');
  const instance = bootstrap.Modal.getInstance(modalEl);
  if(instance) instance.hide();
}

// ===== submit (add / edit) =====
document.getElementById('crudForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const form = new FormData(this); 
  let payload = {};
  form.forEach((v,k)=>payload[k]=v);

  // Auto-assign created_by if field exists in table and not shown in modal
if (currentTable === "userorganizationcentrelink") {
    payload["created_by"] = 1;   // <-- put logged-in user ID here
}


  // Convert checkboxes to boolean
  ["SEND_SMS","SEND_EMAIL"].forEach(f => {
    if(payload[f] === "on") payload[f] = true;
    else payload[f] = false;
  });
  
  // üëâ Special case: Device-Sensor Link me Org & Centre auto-attach
  if(currentTable === "devicesensorlink"){
    const device = dropdownData.devices.find(d => d.DEVICE_ID == payload.DEVICE_ID);
    if(device){
      payload.ORGANIZATION_ID = device.ORGANIZATION_ID;
      payload.CENTRE_ID = device.CENTRE_ID;
    }
  }

  if (currentTable === "createuser") {
  const username = document.getElementById("USERNAME").value.trim();

  const exists = (dropdownData.user || []).some(
    u => u.USERNAME.toLowerCase() === username.toLowerCase()
  );

  if (exists) {
    alert("Username already exists. Please choose another.");
    return;
  }
}


  // primary key detect
  const pk = PRIMARY_KEYS[currentTable];
  const id = payload[pk];
  const isEdit = id && id.trim() !== "" ? true : false;

  if(!isEdit){
    delete payload[pk];  // add me PK hata do
  }

  const url = isEdit ? API[currentTable] + id + "/" : API[currentTable];
  const method = isEdit ? 'PUT' : 'POST';

  let res = await fetch(url,{
    method: method,
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

const messageDiv = document.getElementById("crudMessage");

if(isEdit){
  closeModal();
} else {
  // Reset form for next add
  this.reset();
  this.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
  const firstField = this.querySelector('input, select, textarea');
  if(firstField) firstField.focus();

  // ‚úÖ Show message inside modal
  messageDiv.innerText = "Saved! Ready for next entry.";
  messageDiv.classList.remove("d-none");
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    messageDiv.classList.add("d-none");
  }, 3000);
}
  loadTable(currentTable); 
  updateSummary();
});

function toggleActiveStatus(deviceId, checkbox) {
  const isActive = checkbox.checked;
  const tr = checkbox.closest("tr");

  // Update UI
  tr.classList.toggle("inactive-row", !isActive);
  checkbox.nextElementSibling.querySelector(".status-text").textContent = isActive ? "Active" : "Inactive";

  // Update backend
  fetch(`${API.masterdevices}${deviceId}/`, {
    method: 'PATCH',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ DEVICE_STATUS: isActive ? 1 : 0 })
  })
  .then(res => {
    if (!res.ok) return res.text().then(txt => { throw new Error(txt); });
    console.log(`‚úÖ DEVICE_STATUS updated`, { DEVICE_ID: deviceId, DEVICE_STATUS: isActive ? 1 : 0 });
  })
  .catch(err => console.error("Failed to update DEVICE_STATUS:", err));
}

function toggleSensorStatus(sensorId, checkbox) {
  const isActive = checkbox.checked;
  const tr = checkbox.closest("tr");

  // Update UI
  tr.classList.toggle("inactive-row", !isActive);
  checkbox.nextElementSibling.querySelector(".status-text").textContent = isActive ? "Active" : "Inactive";

  // Update backend
  fetch(`${API.mastersensor}${sensorId}/`, {
    method: 'PATCH',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ SENSOR_STATUS: isActive ? 1 : 0 })
  })
  .then(res => {
    if (!res.ok) return res.text().then(txt => { throw new Error(txt); });
    console.log(`‚úÖ SENSOR_STATUS updated`, { SENSOR_ID: sensorId, SENSOR_STATUS: isActive ? 1 : 0 });
  })
  .catch(err => console.error("Failed to update SENSOR_STATUS:", err));
}

// function toggleUserStatus(userId, checkbox) {
//   const isActive = checkbox.checked;
//   const tr = checkbox.closest("tr");

//   // Update UI
//   tr.classList.toggle("inactive-row", !isActive);
//   checkbox.nextElementSibling.querySelector(".status-text").textContent =
//     isActive ? "Active" : "Inactive";

//   // Update backend
//   fetch(`${API.createuser}${userId}/`, {
//     method: "PATCH",
//     headers: { "Content-Type": "application/json" },
//     body: JSON.stringify({ IS_ACTIVE: isActive ? 1 : 0 })
//   })
//   .then(res => {
//     if (!res.ok) return res.text().then(txt => { throw new Error(txt); });
//     console.log("‚úÖ USER_STATUS updated:", { USER_ID: userId, IS_ACTIVE: isActive });
//   })
//   .catch(err => console.error("Failed to update USER_STATUS:", err));
// }

// ===== Delete =====
async function deleteRow(id){
  if(id==null || id===""){ alert("Invalid ID"); return; }
  if(!confirm("Delete this row?")) return;

  const pk = PRIMARY_KEYS[currentTable];  // use correct PK
  try{
    const res = await fetch(API[currentTable] + id + "/", { method:'DELETE' });
    if(!res.ok){
      const txt = await res.text();
      console.error("Delete Error", res.status, txt);
      alert(`Delete failed ${res.status}: ${txt}`);
      return;
    }
  }catch(err){
    console.error("Delete failed:", err);
    alert("Delete request failed.");
    return;
  }
  await loadTable(currentTable);
  updateSummary();
}
// Function to show a dynamic Bootstrap popup message
function showPopupMessage(title, message) {
  // Remove existing popup if any
  const existingPopup = document.getElementById('dynamicPopupModal');
  if (existingPopup) existingPopup.remove();

  const popupHtml = `
    <div class="modal fade" id="dynamicPopupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${title}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>${message}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', popupHtml);
  const modalEl = document.getElementById('dynamicPopupModal');
  const bootstrapModal = new bootstrap.Modal(modalEl);
  bootstrapModal.show();

  // Remove modal from DOM after hiding
  modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
}
// Updated renew function using popup instead of alert ‚Äî new record insert karega
async function renew(id) {
  if (!id) {
    showPopupMessage("Invalid ID", "Please provide a valid subscription ID.");
    return;
  }

  const sub = currentData.find(r => r[PRIMARY_KEYS[currentTable]] == id);
  if (!sub) {
    showPopupMessage("Not Found", "Subscription not found!");
    return;
  }

  // üîπ Open schedule form for future subscription
  openScheduleForm(sub);
}



function openScheduleForm(subscription) {
  const device = dropdownData.devices.find(d => d.DEVICE_ID === subscription.Device_ID);
  const deviceName = device ? device.DEVICE_NAME : `ID: ${subscription.Device_ID}`;

  const existingModal = document.getElementById('dynamicScheduleModal');
  if (existingModal) existingModal.remove();

  const modalHtml = `
    <div class="modal fade" id="dynamicScheduleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Schedule Subscription</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="dynamicScheduleForm">
              <div class="mb-3">
                <label class="form-label">Device Name</label>
                <input type="text" class="form-control" value="${deviceName}" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="scheduleStartDate" value="${new Date().toISOString().split('T')[0]}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="scheduleEndDate" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="scheduleSubmit">Schedule</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modalEl = document.getElementById('dynamicScheduleModal');
  const bootstrapModal = new bootstrap.Modal(modalEl);
  bootstrapModal.show();

  document.getElementById('scheduleSubmit').onclick = () => {
    const startDate = document.getElementById('scheduleStartDate').value;
    const endDate = document.getElementById('scheduleEndDate').value;

    if (!startDate || !endDate) {
      alert("Please fill all date fields.");
      return;
    }

    if (new Date(endDate) < new Date(startDate)) {
      alert("End date cannot be earlier than Start date.");
      return;
    }

    // üîπ Ensure new subscription starts after current subscription ends
    const currentEnd = new Date(subscription.Subcription_End_date);
    if (new Date(startDate) <= currentEnd) {
      alert(`New subscription must start after current subscription ends (${subscription.Subcription_End_date}).`);
      return;
    }

    fetch(API[currentTable], {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        Device_ID: subscription.Device_ID,
        Subscription_Start_date: startDate,
        Subcription_End_date: endDate,
        Subscription_ID: subscription.Subscription_ID,
        Plan_ID: subscription.Plan_ID,
        Payment_Date: new Date().toISOString().split('T')[0],
        Status: "Future"  // initially future
      })
    })
    .then(res => {
      if (!res.ok) return res.text().then(txt => { throw new Error(txt); });
      return res.json();
    })
    .then(data => {
      alert("‚úÖ Subscription scheduled successfully!");
      bootstrapModal.hide();
      modalEl.remove();
      loadTable(currentTable); // Refresh table
    })
    .catch(err => {
      console.error("Schedule failed:", err);
      alert("‚ùå Failed to schedule subscription: " + err.message);
    });
  };

  modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
}


// Modal form for renewing subscription (creates new entry instead of updating)
function openRenewForm(subscription) {
  const device = dropdownData.devices.find(d => d.DEVICE_ID === subscription.Device_ID);
  const deviceName = device ? device.DEVICE_NAME : `ID: ${subscription.Device_ID}`;

  // Remove existing modal if any
  const existingModal = document.getElementById('dynamicRenewModal');
  if (existingModal) existingModal.remove();

  // Create modal dynamically
  const modalHtml = `
    <div class="modal fade" id="dynamicRenewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Renew Subscription</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="dynamicRenewForm">
              <div class="mb-3">
                <label class="form-label">Device Name</label>
                <input type="text" class="form-control" value="${deviceName}" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">New Start Date</label>
                <input type="date" class="form-control" id="dynamicStartDate" value="${new Date().toISOString().split('T')[0]}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">New End Date</label>
                <input type="date" class="form-control" id="dynamicEndDate" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="dynamicRenewSubmit">Renew</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);

  const modalEl = document.getElementById('dynamicRenewModal');
  const bootstrapModal = new bootstrap.Modal(modalEl);
  bootstrapModal.show();

  // Handle Renew Submit
  document.getElementById('dynamicRenewSubmit').onclick = () => {
    const newStartDate = document.getElementById('dynamicStartDate').value;
    const newEndDate = document.getElementById('dynamicEndDate').value;

    if (!newStartDate || !newEndDate) {
      alert("Please fill all date fields.");
      return;
    }

      if (new Date(newEndDate) < new Date(newStartDate)) {
    alert("End date cannot be earlier than Start date.");
    return;
  }

    fetch(API[currentTable], {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        Device_ID: subscription.Device_ID,
        Subscription_Start_date: newStartDate,
        Subcription_End_date: newEndDate,
        Subscription_ID: subscription.Subscription_ID,
        Plan_ID: subscription.Plan_ID,
        Payment_Date: new Date().toISOString().split('T')[0],
        Status: "Active"
      })
    })
      .then(res => {
        if (!res.ok) return res.text().then(txt => { throw new Error(txt); });
        return res.json();
      })
      .then(data => {
        alert("‚úÖ Subscription renewed successfully!");
        bootstrapModal.hide();
        modalEl.remove();
        loadTable(currentTable); // Refresh the table
      })
      .catch(err => {
        console.error("Renew failed:", err);
        alert("‚ùå Failed to renew subscription: " + err.message);
      });
  };

  // Clean modal when closed
  modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
}



// ===== Summary cards =====
// async function updateSummary(){
//   try{
//     const [d,p,s,o] = await Promise.all([
//       fetchJSON(API.masterdevices),
//       fetchJSON(API.masterparameter),
//       fetchJSON(API.mastersensor),
//       fetchJSON(API.masterorganizations)
//     ]);
//     document.getElementById('totalDevices').innerText=d.length;
//     document.getElementById('totalParameters').innerText=p.length;
//     document.getElementById('totalSensors').innerText=s.length;
//     document.getElementById('totalOrganizations').innerText=o.length;
//   }catch(e){ console.warn("Summary update skipped:", e); }
// }

async function updateSummary() {
  try {
    const devices = await fetchJSON(API.masterdevices);
    const orgs    = await fetchJSON(API.masterorganizations);
    const readings = await fetchJSON(API.devicereadinglog);
    const alarms = await fetchJSON(API.devicealarmlog);
    const statuslog = await fetchJSON(API.devicestatusalarmlog);

    // Total devices
    document.getElementById("totalOrganizations").innerText = orgs.length;
    document.getElementById("totalDevices").innerText = devices.length;

    const online = statuslog.filter(s => Number(s.DEVICE_STATUS) === 1);
    const offline = statuslog.filter(s => Number(s.DEVICE_STATUS) === 0);

    window.summaryData = {
        organizations: orgs,
        devices: devices,
        online: online,
        offline: offline,
        readings: readings,
        alarms: alarms,
        statuslog: statuslog
    };

  } catch (e) {
    console.warn("Summary update skipped:", e);
  }
}





// ===== init =====
document.addEventListener("DOMContentLoaded", () => {
  loadDropdowns();
  updateSummary();
});
</script>

</script>



<h2 id="tableTitle"></h2>
</body>
</html>
